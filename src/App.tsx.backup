import React, { useState, useEffect, useMemo, useRef, useCallback } from 'react';
import CountUp from 'react-countup';
import {
  Dialog,
  DialogContent,
  DialogActions,
  Button,
  TextField,
  Box,
  Typography,
  IconButton,
  Chip,
  Tooltip,
  Paper,
  ThemeProvider,
  createTheme
} from '@mui/material';
import {
  Share as ShareIcon,
  ContentCopy as CopyIcon,
  Close as CloseIcon,
  Link as LinkIcon
} from '@mui/icons-material';

interface Player {
  id: number;
  name: string;
  ping: number;
  identifiers: string[];
  endpoint: string;
}

interface ServerData {
  dynamic: any;
  players: Player[];
}

interface PlayerWithDiscord extends Player {
  discordId?: string;
  discordAvatar?: string;
}

interface ServerHistoryItem {
  address: string;
  customName?: string;
  logo?: string;
  lastUsed: number;
}

const fetchDiscordAvatar = async (discordId: string): Promise<string | undefined> => {
  try {
    const corsProxy = 'https://corsproxy.io/?';
    const response = await fetch(`${corsProxy}https://itools.zone/fivem/a.php?user_id=${discordId}`, {
      signal: AbortSignal.timeout(5000)
    });

    if (response.ok) {
      const data = await response.json();
      if (data.id && data.avatar) {
        return `https://cdn.discordapp.com/avatars/${data.id}/${data.avatar}.png`;
      }
    }
  } catch (error) {
    console.warn('Error fetching Discord profile:', error);
  }

  return `https://cdn.discordapp.com/avatars/${discordId}/avatar.png`;
};

const App: React.FC = () => {
  const [serverIp, setServerIp] = useState('');
  const [serverPort, setServerPort] = useState('30120');
  const [serverData, setServerData] = useState<ServerData | null>(null);
  const [selectedPlayer, setSelectedPlayer] = useState<PlayerWithDiscord | null>(null);
  const [searchName, setSearchName] = useState('');
  const [searchId, setSearchId] = useState('');
  const [searchIdError, setSearchIdError] = useState('');
  const [serverStatus, setServerStatus] = useState<'online' | 'offline' | 'connecting' | 'error'>('offline');

  const [connectionStartTime, setConnectionStartTime] = useState<number | null>(null);

  // Discord Auth States
  const [discordUser, setDiscordUser] = useState<{
    id: string;
    username: string;
    discriminator: string;
    avatar: string;
    global_name?: string;
    avatar_url?: string;
  } | null>(null);
  const [isDiscordLoading, setIsDiscordLoading] = useState(false);

  // Cache to prevent processing the same authorization code multiple times
  const processedCodesRef = useRef<Set<string>>(new Set());

  // Ref to store current allPlayers for interval access
  const allPlayersRef = useRef<PlayerWithDiscord[]>([]);

  // Share Options States
  const [showShareOptions, setShowShareOptions] = useState(false);

  const [allPlayers, setAllPlayers] = useState<PlayerWithDiscord[]>([]);
  const [isLoadingPlayers, setIsLoadingPlayers] = useState(false);
  const [currentTheme, setCurrentTheme] = useState('dark');
  const [showLoading, setShowLoading] = useState(false);
  const [notifications, setNotifications] = useState<{ id: number, type: 'success' | 'error', message: string }[]>([]);
  const [serverHistory, setServerHistory] = useState<ServerHistoryItem[]>([]);
  const [currentPage, setCurrentPage] = useState(1);
  const playersPerPage = 20;
  const [showSettingsModal, setShowSettingsModal] = useState(false);
  const [showEditModal, setShowEditModal] = useState(false);
  const [editingServer, setEditingServer] = useState<ServerHistoryItem | null>(null);
  const [editName, setEditName] = useState('');
  const [editLogo, setEditLogo] = useState('');
  const [logoType, setLogoType] = useState<'url' | 'file'>('url');
  const nameInputRef = useRef<HTMLInputElement>(null);

  // Share Link Feature States
  const [showShareDialog, setShowShareDialog] = useState(false);
  const [shareUrl, setShareUrl] = useState('');
  const [customShareName, setCustomShareName] = useState('');
  const [isSharedLink, setIsSharedLink] = useState(false);
  const [sharedFromUser, setSharedFromUser] = useState('');
  const [isGeneratingUrl, setIsGeneratingUrl] = useState(false);
  const [showOAuthHelp, setShowOAuthHelp] = useState(false);
  const [isProcessingOAuth, setIsProcessingOAuth] = useState(false);
  const [showSharedByDropdown, setShowSharedByDropdown] = useState(false);



  // Material-UI Theme
  const muiTheme = createTheme({
    palette: {
      mode: currentTheme === 'dark' ? 'dark' : 'light',
      primary: {
        main: '#3b82f6',
      },
      secondary: {
        main: '#10b981',
      },
      background: {
        default: currentTheme === 'dark' ? '#0f172a' : '#f8fafc',
        paper: currentTheme === 'dark' ? '#1e293b' : '#ffffff',
      },
      text: {
        primary: currentTheme === 'dark' ? '#ffffff' : '#1f2937',
        secondary: currentTheme === 'dark' ? '#d1d5db' : '#6b7280',
      },
    },
    typography: {
      fontFamily: 'inherit',
    },
    components: {
      MuiDialog: {
        styleOverrides: {
          paper: {
            backgroundColor: currentTheme === 'dark' ? '#1e293b' : '#ffffff',
            color: currentTheme === 'dark' ? '#ffffff' : '#1f2937',
          }
        }
      },
      MuiChip: {
        styleOverrides: {
          root: {
            backgroundColor: currentTheme === 'dark' ? '#374151' : '#e5e7eb',
            color: currentTheme === 'dark' ? '#ffffff' : '#1f2937',
          }
        }
      }
    }
  });


  useEffect(() => {
    const urlParams = new URLSearchParams(window.location.search);

    // Handle Discord OAuth callback
    const discordCode = urlParams.get('code');
    const discordError = urlParams.get('error');

    if ((discordCode || discordError) && !isProcessingOAuth) {
      // Check if we've already processed this code
      if (discordCode && processedCodesRef.current.has(discordCode)) {
        console.log('Authorization code already processed, skipping');
        // Clean up URL without processing
        const newUrl = new URL(window.location.href);
        newUrl.searchParams.delete('code');
        newUrl.searchParams.delete('error');
        newUrl.searchParams.delete('state');
        window.history.replaceState({}, document.title, newUrl.toString());
        return;
      }

      // Add code to processed cache
      if (discordCode) {
        processedCodesRef.current.add(discordCode);
      }

      // Immediately clear the URL to prevent reprocessing the same code
      const newUrl = new URL(window.location.href);
      newUrl.searchParams.delete('code');
      newUrl.searchParams.delete('error');
      newUrl.searchParams.delete('state');
      window.history.replaceState({}, document.title, newUrl.toString());

      // Only show help banner if there's an error
      if (discordError) {
        setShowOAuthHelp(true);
      }
      setIsProcessingOAuth(true);
      handleDiscordCallback(discordCode, discordError);
      return;
    }

    // Check for new format first (encoded)
    const serverParam = urlParams.get('s');
    const sharedByParam = urlParams.get('by');

    // Check for old format (backward compatibility)
    const ipParam = urlParams.get('ip_address');
    const portParam = urlParams.get('port');
    const serverNameParam = urlParams.get('server_name');

    let serverData = null;

    if (serverParam) {
      // New format - decode the server data
      serverData = decodeServerData(serverParam);
      if (serverData) {
        setIsSharedLink(true);
        if (sharedByParam) {
          setSharedFromUser(decodeURIComponent(sharedByParam));
        }
      }
    } else if (ipParam) {
      // Old format - backward compatibility
      serverData = {
        ip: ipParam,
        port: portParam || '30120',
        name: serverNameParam
      };
      setIsSharedLink(true);
    }

    if (serverData) {
      setServerIp(serverData.ip);
      setServerPort(serverData.port);
      if (serverData.name) {
        setCustomShareName(serverData.name);
      }

      // Auto-fetch data if URL contains server info
      setTimeout(() => {
        fetchServerDataWithParams(serverData.ip, serverData.port);
      }, 100);
    }



    // Set initial theme to dark by default
    const savedTheme = localStorage.getItem('theme') || 'dark';

    // Apply theme immediately
    document.documentElement.setAttribute('data-theme', savedTheme);
    if (savedTheme === 'dark') {
      document.documentElement.classList.add('dark');
      document.body.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
      document.body.classList.remove('dark');
    }

    setCurrentTheme(savedTheme);
    console.log('Initial theme loaded:', savedTheme);

    // Load server history from localStorage
    const savedHistory = localStorage.getItem('serverHistory');
    if (savedHistory) {
      try {
        const history = JSON.parse(savedHistory as string);
        // Convert old format to new format if needed
        const convertedHistory = history.map((item: any) =>
          typeof item === 'string'
            ? { address: item, lastUsed: Date.now() }
            : item
        );
        setServerHistory(convertedHistory);
      } catch (error) {
        console.warn('Failed to parse server history:', error);
      }
    }


  }, []);

  // Cleanup effect to prevent OAuth processing after unmount
  useEffect(() => {
    return () => {
      setIsProcessingOAuth(false);
      processedCodesRef.current.clear();
    };
  }, []);

  // Debug useEffect to track state changes
  useEffect(() => {
    console.log('State updated - serverIp:', serverIp, 'serverPort:', serverPort);
  }, [serverIp, serverPort]);

  // Manual URL generation only - no auto-generate to prevent lag

  const changeTheme = (theme: string) => {
    // Update HTML attributes
    document.documentElement.setAttribute('data-theme', theme);

    // Update classes properly
    if (theme === 'dark') {
      document.documentElement.classList.add('dark');
      document.body.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
      document.body.classList.remove('dark');
    }

    // Save to localStorage
    localStorage.setItem('theme', theme);
    setCurrentTheme(theme);

    // Force a small delay to ensure DOM updates
    setTimeout(() => {
      console.log('Theme changed to:', theme);
    }, 100);
  };

  const addToServerHistory = (serverAddress: string) => {
    const fullAddress = `${serverAddress}:${serverPort}`;
    setServerHistory(prev => {
      // Find existing entry to preserve customName and logo
      const existingEntry = prev.find(item => item.address === fullAddress);

      // Remove if already exists to avoid duplicates
      const filtered = prev.filter(item => item.address !== fullAddress);

      // Add to beginning of array (most recent first), preserving custom data
      const newHistory = [
        {
          address: fullAddress,
          lastUsed: Date.now(),
          customName: existingEntry?.customName,
          logo: existingEntry?.logo
        },
        ...filtered
      ].slice(0, 5); // Keep only last 5

      // Save to localStorage
      localStorage.setItem('serverHistory', JSON.stringify(newHistory));
      return newHistory;
    });
  };

  const selectFromHistory = (historyItem: ServerHistoryItem) => {
    const [ip, port] = historyItem.address.split(':');
    setServerIp(ip);
    setServerPort(port || '30120');
  };

  const addNotification = (type: 'success' | 'error', message: string) => {
    const id = Date.now();
    setNotifications(prev => [...prev, { id, type, message }]);

    // Auto remove after 4 seconds
    setTimeout(() => {
      setNotifications(prev => prev.filter(n => n.id !== id));
    }, 4000);
  };

  const removeNotification = (id: number) => {
    setNotifications(prev => prev.filter(n => n.id !== id));
  };

  const removeFromHistory = (historyItem: ServerHistoryItem) => {
    setServerHistory(prev => {
      const newHistory = prev.filter(item => item.address !== historyItem.address);
      localStorage.setItem('serverHistory', JSON.stringify(newHistory));
      return newHistory;
    });
  };

  const clearAllHistory = () => {
    setServerHistory([]);
    localStorage.removeItem('serverHistory');
  };

  const startEditingServer = (item: ServerHistoryItem) => {
    setEditingServer(item);
    setEditName(item.customName || '');
    setEditLogo(item.logo || '');
    // Detect logo type
    if (item.logo) {
      if (item.logo.startsWith('data:')) {
        setLogoType('file');
      } else {
        setLogoType('url');
      }
    } else {
      setLogoType('url');
    }
    setShowEditModal(true);
  };

  const saveServerEdit = () => {
    if (!editingServer) return;

    setServerHistory(prev => {
      const newHistory = prev.map(item =>
        item.address === editingServer.address
          ? { ...item, customName: editName.trim() || undefined, logo: editLogo.trim() || undefined }
          : item
      );
      localStorage.setItem('serverHistory', JSON.stringify(newHistory));
      return newHistory;
    });
    cancelEdit();
  };

  const cancelEdit = () => {
    setEditingServer(null);
    setEditName('');
    setEditLogo('');
    setLogoType('url');
    setShowEditModal(false);
  };

  const handleFileUpload = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (file && file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const result = e.target?.result as string;
        setEditLogo(result);
      };
      reader.readAsDataURL(file);
    }
  };

  const copyPlayerData = () => {
    if (!selectedPlayer) return;

    const pingStatus = selectedPlayer.ping < 50 ? 'EXCELLENT' :
      selectedPlayer.ping < 100 ? 'GOOD' : 'HIGH';

    const playerData = `
================================================================================
                            FIVEM PLAYER REPORT
================================================================================

PLAYER INFORMATION
├─ Name: ${selectedPlayer.name}
├─ Player ID: ${selectedPlayer.id}
├─ Ping: ${selectedPlayer.ping}ms (${pingStatus})${selectedPlayer.endpoint && !selectedPlayer.endpoint.startsWith('127.0.0.1') ? `
├─ Endpoint: ${selectedPlayer.endpoint}` : ''}${selectedPlayer.discordId ? `
└─ Discord ID: ${selectedPlayer.discordId}` : ''}

SERVER INFORMATION
├─ Server: ${serverIp}:${serverPort}
├─ Timestamp: ${new Date().toLocaleString('th-TH')}
└─ Generated by: FiveM Player Monitor (บาร็อง อิสหาด)

================================================================================
    `.trim();

    navigator.clipboard.writeText(playerData).then(() => {
      addNotification('success', 'คัดลอกข้อมูลผู้เล่นเรียบร้อยแล้ว');
    }).catch(() => {
      addNotification('error', 'ไม่สามารถคัดลอกข้อมูลได้');
    });
  };

  // URL Encoding/Decoding Functions
  const encodeServerData = (ip: string, port: string, name?: string) => {
    const data = { ip, port, ...(name && { name }) };
    const encoded = btoa(JSON.stringify(data));
    return encoded.replace(/[+/=]/g, (match) => {
      switch (match) {
        case '+': return '-';
        case '/': return '_';
        case '=': return '';
        default: return match;
      }
    });
  };

  const decodeServerData = (encoded: string) => {
    try {
      // Restore base64 padding and characters
      let restored = encoded.replace(/[-_]/g, (match) => {
        return match === '-' ? '+' : '/';
      });

      // Add padding if needed
      while (restored.length % 4) {
        restored += '=';
      }

      const decoded = atob(restored);
      return JSON.parse(decoded);
    } catch (error) {
      console.warn('Failed to decode server data:', error);
      return null;
    }
  };

  // Share Link Functions
  const generateShareUrlManual = () => {
    setIsGeneratingUrl(true);
    // Check if serverIp is empty, try to get from URL params as fallback
    let currentServerIp = serverIp.trim();
    let currentServerPort = serverPort;

    if (!currentServerIp) {
      const urlParams = new URLSearchParams(window.location.search);
      const ipParam = urlParams.get('ip_address');
      const portParam = urlParams.get('port');
      const serverParam = urlParams.get('s');

      if (ipParam) {
        currentServerIp = ipParam;
        currentServerPort = portParam || '30120';
      } else if (serverParam) {
        const decoded = decodeServerData(serverParam);
        if (decoded) {
          currentServerIp = decoded.ip;
          currentServerPort = decoded.port;
        }
      }

      if (!currentServerIp) {
        setShareUrl('');
        return;
      }
    }

    const baseUrl = window.location.origin + window.location.pathname;
    const encoded = encodeServerData(currentServerIp, currentServerPort, customShareName.trim() || undefined);

    let url = `${baseUrl}?s=${encoded}`;
    if (sharedFromUser.trim()) {
      url += `&by=${encodeURIComponent(sharedFromUser.trim())}`;
    }

    setShareUrl(url);
    setIsGeneratingUrl(false);
  };

  const generateShareUrl = () => {
    console.log('generateShareUrl called, serverIp:', serverIp, 'serverPort:', serverPort);

    // Check if we have server data
    if (!serverIp.trim() && !window.location.search) {
      addNotification('error', 'กรุณาใส่ที่อยู่เซิร์ฟเวอร์ก่อน');
      return;
    }



    // Show dialog (useEffect will handle URL generation)
    setShowShareDialog(true);
  };

  const copyShareUrl = async () => {
    try {
      await navigator.clipboard.writeText(shareUrl);
      addNotification('success', 'คัดลอกลิงก์เรียบร้อยแล้ว!');
    } catch (error) {
      addNotification('error', 'ไม่สามารถคัดลอกลิงก์ได้');
    }
  };

  const handleShareDialogClose = () => {
    setShowShareDialog(false);
    setShareUrl('');
    setCustomShareName('');
    setLocalCustomShareName('');
    setLocalSharedFromUser('');
    setShowShareOptions(false);
    setIsGeneratingUrl(false);
  };

  // Discord OAuth Functions
  const loginWithDiscord = () => {
    const clientId = import.meta.env.VITE_DISCORD_CLIENT_ID;

    if (!clientId) {
      addNotification('error', 'Discord Client ID not configured. Please check .env.local file.');
      return;
    }

    // Clean up any existing URL parameters first
    window.history.replaceState({}, document.title, window.location.pathname);

    setIsDiscordLoading(true);
    const redirectUri = encodeURIComponent(window.location.origin);
    const scope = 'identify';

    const discordAuthUrl = `https://discord.com/api/oauth2/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&response_type=code&scope=${scope}`;

    // Redirect to Discord OAuth (no popup needed)
    window.location.href = discordAuthUrl;
  };

  const clearUrlAndRetry = () => {
    // Clean up URL and allow user to try again
    const newUrl = new URL(window.location.href);
    newUrl.searchParams.delete('code');
    newUrl.searchParams.delete('error');
    newUrl.searchParams.delete('state');
    window.history.replaceState({}, document.title, newUrl.toString());

    // Clear processed codes cache to allow retry
    processedCodesRef.current.clear();

    setIsDiscordLoading(false);
    setShowOAuthHelp(false);
    setIsProcessingOAuth(false);
    addNotification('success', 'URL cleared. You can try logging in again.');
  };

  const logoutDiscord = () => {
    setDiscordUser(null);
    localStorage.removeItem('discordUser');
  };



  const handleDiscordCallback = async (code: string | null, error: string | null) => {
    console.log('Discord callback received:', { code: code?.substring(0, 10) + '...', error });

    if (error) {
      addNotification('error', `Discord authentication failed: ${error}`);
      setShowOAuthHelp(true);
      setIsProcessingOAuth(false);
      // URL already cleaned up in useEffect
      return;
    }

    if (!code) {
      addNotification('error', 'No authorization code received from Discord');
      setShowOAuthHelp(true);
      setIsProcessingOAuth(false);
      // URL already cleaned up in useEffect
      return;
    }

    // Check if code looks expired or invalid
    if (code.length < 10) {
      addNotification('error', 'Invalid authorization code. Please try logging in again.');
      setShowOAuthHelp(true);
      setIsProcessingOAuth(false);
      // URL already cleaned up in useEffect
      return;
    }

    setIsDiscordLoading(true);

    try {
      const clientId = import.meta.env.VITE_DISCORD_CLIENT_ID;
      const clientSecret = import.meta.env.VITE_DISCORD_CLIENT_SECRET;

      // Try both possible redirect URIs to handle the port mismatch issue
      const possibleRedirectUris = [
        window.location.origin, // Current origin (http://localhost:5173)
        'http://localhost:3000', // Original redirect URI that might be in Discord settings
        'http://localhost:5173'  // Explicit Vite port
      ];

      let tokenData = null;
      let lastError = null;

      // Try each redirect URI until one works
      for (const redirectUri of possibleRedirectUris) {
        try {
          console.log(`Trying redirect URI: ${redirectUri}`);

          const tokenResponse = await fetch('https://discord.com/api/oauth2/token', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
              client_id: clientId,
              client_secret: clientSecret,
              grant_type: 'authorization_code',
              code: code,
              redirect_uri: redirectUri,
            }),
          });

          if (tokenResponse.ok) {
            tokenData = await tokenResponse.json();
            console.log('Token exchange successful with redirect URI:', redirectUri);
            break;
          } else {
            const errorData = await tokenResponse.json().catch(() => ({}));
            lastError = errorData;
            console.warn(`Failed with redirect URI ${redirectUri}:`, errorData);
          }
        } catch (err) {
          console.warn(`Error with redirect URI ${redirectUri}:`, err);
          lastError = err;
        }
      }

      if (!tokenData) {
        throw new Error(lastError?.error_description || 'Failed to exchange code for token with any redirect URI');
      }

      // Get user info with more detailed data
      const userResponse = await fetch('https://discord.com/api/users/@me', {
        headers: {
          'Authorization': `Bearer ${tokenData.access_token}`,
          'User-Agent': 'FiveM Player Monitor (https://github.com/your-repo, 1.0.5)',
        },
      });

      if (!userResponse.ok) {
        const errorText = await userResponse.text();
        console.error('User info error:', errorText);
        throw new Error('Failed to get user information');
      }

      const userData = await userResponse.json();
      console.log('Discord user data received:', userData);

      // Enhance user data with avatar URL if available
      const enhancedUserData = {
        ...userData,
        avatar_url: userData.avatar
          ? `https://cdn.discordapp.com/avatars/${userData.id}/${userData.avatar}.${userData.avatar.startsWith('a_') ? 'gif' : 'png'}?size=128`
          : `https://cdn.discordapp.com/embed/avatars/${parseInt(userData.discriminator) % 5}.png`
      };

      setDiscordUser(enhancedUserData);
      addNotification('success', `Welcome, ${enhancedUserData.global_name || enhancedUserData.username}!`);

      // Hide OAuth help banner on success
      setShowOAuthHelp(false);

      // URL already cleaned up in useEffect

    } catch (error) {
      console.error('Discord OAuth error:', error);

      let errorMessage = 'Unknown error';
      if (error instanceof Error) {
        errorMessage = error.message;

        // Provide more helpful error messages
        if (errorMessage.includes('Invalid "code"')) {
          errorMessage = 'Authorization code expired or invalid. Please try logging in again.';
        } else if (errorMessage.includes('redirect_uri')) {
          errorMessage = 'Redirect URI mismatch. Please check Discord application settings.';
        }
      }

      addNotification('error', `Discord authentication failed: ${errorMessage}`);

      // Show help banner on error
      setShowOAuthHelp(true);

      // URL already cleaned up in useEffect
    } finally {
      setIsDiscordLoading(false);
      setIsProcessingOAuth(false);
    }
  };



  // Load Discord user from localStorage on mount
  useEffect(() => {
    const savedUser = localStorage.getItem('discordUser');
    if (savedUser) {
      try {
        setDiscordUser(JSON.parse(savedUser));
      } catch (error) {
        console.warn('Failed to parse saved Discord user');
        localStorage.removeItem('discordUser'); // Clean up invalid data
      }
    }

    // Log configuration status (development only)
    if (import.meta.env.DEV) {
      console.log('Discord OAuth Configuration:', {
        clientId: import.meta.env.VITE_DISCORD_CLIENT_ID ? 'Configured' : 'Missing',
        redirectUri: import.meta.env.VITE_DISCORD_REDIRECT_URI || 'Using default',
        version: import.meta.env.VITE_APP_VERSION || '1.0.5'
      });
    }
  }, []);

  // Save Discord user to localStorage when it changes
  useEffect(() => {
    if (discordUser) {
      localStorage.setItem('discordUser', JSON.stringify(discordUser));
      // Hide OAuth help banner when user is logged in
      setShowOAuthHelp(false);
    }
  }, [discordUser]);




  // Navigation handlers
  const handleSettingsToggle = useCallback(() => {
    setShowSettingsModal(!showSettingsModal);
  }, [showSettingsModal]);

  const handleThemeChange = useCallback((theme: string) => {
    changeTheme(theme);
    setShowSettingsModal(false);
  }, []);

  // Local state for inputs to prevent lag
  const [localCustomShareName, setLocalCustomShareName] = useState('');
  const [localSharedFromUser, setLocalSharedFromUser] = useState('');

  // Sync local state with main state when dialog opens
  useEffect(() => {
    if (showShareDialog) {
      setLocalCustomShareName(customShareName);
      setLocalSharedFromUser(sharedFromUser);
    }
  }, [showShareDialog, customShareName, sharedFromUser]);

  // Optimized input handlers
  const handleCustomShareNameChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    setLocalCustomShareName(value);
    setCustomShareName(value);
  }, []);

  const handleSharedFromUserChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    setLocalSharedFromUser(value);
    setSharedFromUser(value);
  }, []);

  // Generate comprehensive SHA256 hash of player data with metadata
  const generatePlayerDataHash = async (players: PlayerWithDiscord[]) => {
    if (!players || players.length === 0) return '';

    try {
      // Create comprehensive data structure for hashing with random salt
      const timestamp = new Date().toISOString();
      const randomSalt = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
      const serverInfo = {
        server: `${serverIp}:${serverPort}`,
        timestamp: timestamp,
        playerCount: players.length,
        maxPlayers: serverData?.dynamic?.sv_maxclients || 'Unknown',
        salt: randomSalt // Add random salt for uniqueness
      };

      const playerDataString = JSON.stringify({
        serverInfo,
        players: players.map(p => ({
          id: p.id,
          name: p.name,
          ping: p.ping,
          identifiers: p.identifiers,
          endpoint: p.endpoint,
          discordId: p.discordId || null
        })).sort((a, b) => a.id - b.id)
      });

      const encoder = new TextEncoder();
      const data = encoder.encode(playerDataString);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

      // Verify hash length and return full 64-character hash
      console.log('Generated hash length:', hashHex.length);
      console.log('Generated hash:', hashHex);

      if (hashHex.length !== 64) {
        console.warn('Hash length is not 64 characters:', hashHex.length);
      }

      return hashHex;
    } catch (error) {
      console.warn('Error generating hash:', error);
      return '';
    }
  };

  const [playerDataHash, setPlayerDataHash] = useState<string>('');
  const [hashCounter, setHashCounter] = useState<number>(0);

  // Hash Display Component with CountUp
  const HashDisplay = ({ hash, counter }: { hash: string, counter: number }) => {
    if (!hash) return null;

    // Convert first 8 characters to number for CountUp
    const hashNumber = parseInt(hash.substring(0, 8), 16);

    return (
      <code className="text-xs font-mono text-slate-600 dark:text-slate-400 break-all leading-relaxed">
        {counter > 0 ? (
          <CountUp
            start={0}
            end={hashNumber}
            duration={1.5}
            preserveValue={true}
            formattingFn={(value) => {
              const hexValue = value.toString(16).padStart(8, '0');
              return hexValue + hash.substring(8);
            }}
          />
        ) : (
          hash
        )}
      </code>
    );
  };



  useEffect(() => {
    const processPlayers = async () => {
      if (!serverData?.players) {
        setAllPlayers([]);
        setIsLoadingPlayers(false);
        return;
      }

      setIsLoadingPlayers(true);

      const playersWithDiscordIds = serverData.players.map(player => {
        const discordIdentifier = player.identifiers.find(id => id.startsWith('discord:'));
        const discordId = discordIdentifier ? discordIdentifier.replace('discord:', '') : undefined;

        return {
          ...player,
          discordId,
          discordAvatar: undefined
        };
      });

      setAllPlayers(playersWithDiscordIds);
      setIsLoadingPlayers(false);

      const loadAvatars = async () => {
        const batchSize = 5; // Increased for better performance

        for (let i = 0; i < playersWithDiscordIds.length; i += batchSize) {
          const batch = playersWithDiscordIds.slice(i, i + batchSize);

          const batchResults = await Promise.all(
            batch.map(async (player) => {
              if (!player.discordId) return player;

              try {
                const discordAvatar = await fetchDiscordAvatar(player.discordId);
                return { ...player, discordAvatar };
              } catch (error) {
                // Reduced console warnings for better performance
                return player;
              }
            })
          );

          setAllPlayers(prevPlayers => {
            const updatedPlayers = [...prevPlayers];
            batchResults.forEach(updatedPlayer => {
              const index = updatedPlayers.findIndex(p => p.id === updatedPlayer.id);
              if (index !== -1) {
                updatedPlayers[index] = updatedPlayer;
              }
            });
            return updatedPlayers;
          });

          if (i + batchSize < playersWithDiscordIds.length) {
            await new Promise(resolve => setTimeout(resolve, 100)); // Faster loading
          }
        }
      };

      loadAvatars();
    };

    processPlayers();
  }, [serverData]);

  // Use useMemo for better performance
  const filteredPlayers = useMemo(() => {
    return allPlayers
      .filter(player => {
        const nameMatch = searchName === '' || player.name.toLowerCase().includes(searchName.toLowerCase());
        const idMatch = searchId === '' || player.id.toString().includes(searchId);
        return nameMatch && idMatch;
      })
      .sort((a, b) => a.id - b.id); // Sort by ID from low to high
  }, [allPlayers, searchName, searchId]);

  // Pagination logic
  const totalPages = Math.ceil(filteredPlayers.length / playersPerPage);
  const paginatedPlayers = useMemo(() => {
    const startIndex = (currentPage - 1) * playersPerPage;
    return filteredPlayers.slice(startIndex, startIndex + playersPerPage);
  }, [filteredPlayers, currentPage, playersPerPage]);

  // Reset to page 1 when search changes
  useEffect(() => {
    setCurrentPage(1);
  }, [searchName, searchId]);



  // Update ref when allPlayers changes
  useEffect(() => {
    allPlayersRef.current = allPlayers;
  }, [allPlayers]);

  // Generate hash when player data changes
  useEffect(() => {
    if (allPlayers.length > 0) {
      generatePlayerDataHash(allPlayers).then(hash => {
        setPlayerDataHash(hash);
        setHashCounter(prev => prev + 1);
      });
    } else {
      setPlayerDataHash('');
      setHashCounter(0);
    }
  }, [allPlayers]);



  // Function to change page and scroll to first player
  const changePage = (newPage: number) => {
    setCurrentPage(newPage);
    // Scroll to first player in the table
    setTimeout(() => {
      const firstPlayerRow = document.querySelector('[data-player-table] tbody tr:first-child');
      if (firstPlayerRow) {
        firstPlayerRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
      } else {
        // Fallback to table header if no players
        const tableHeader = document.querySelector('[data-player-table] thead');
        if (tableHeader) {
          tableHeader.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }
    }, 150);
  };

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as Element;

      if (showSettingsModal && !target.closest('[data-settings-dropdown]')) {
        setShowSettingsModal(false);
      }

      if (showShareOptions && !target.closest('[data-share-dropdown]')) {
        setShowShareOptions(false);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, [showSettingsModal, showShareOptions]);

  const fetchServerDataWithParams = async (ip: string, port: string) => {
    if (!ip.trim()) {
      addNotification('error', 'กรุณาใส่ IP หรือ Domain ของเซิร์ฟเวอร์');
      return;
    }
    setShowLoading(true);
    setServerStatus('connecting');
    setConnectionStartTime(Date.now());

    try {
      const serverAddress = `${ip}:${port}`;
      const corsProxies = [
        'https://corsproxy.io/?',
        'https://api.allorigins.win/raw?url='
      ];

      let serverInfo = null;
      let players = [];

      for (const corsProxy of corsProxies) {
        try {
          const infoUrl = corsProxy + encodeURIComponent('https://fivem-id.com/information');

          const infoResponse = await fetch(infoUrl, {
            method: 'POST',
            headers: {
              'Accept': 'application/json, text/javascript, */*; q=0.01',
              'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
              'Origin': 'https://fivem-id.com',
              'Referer': 'https://fivem-id.com/',
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36'
            },
            body: `server=${encodeURIComponent(serverAddress)}`,
            signal: AbortSignal.timeout(15000)
          });

          if (infoResponse.ok) {
            serverInfo = await infoResponse.json();
            break;
          }
        } catch (error) {
          console.warn(`Failed to get server info via ${corsProxy}:`, error);
          continue;
        }
      }

      // Try to get players data
      for (const corsProxy of corsProxies) {
        try {
          const playersUrl = corsProxy + encodeURIComponent('https://fivem-id.com/ajax');

          const playersResponse = await fetch(playersUrl, {
            method: 'POST',
            headers: {
              'Accept': 'application/json, text/javascript, */*; q=0.01',
              'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
              'Origin': 'https://fivem-id.com',
              'Referer': 'https://fivem-id.com/',
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36'
            },
            body: `server=${encodeURIComponent(serverAddress)}`,
            signal: AbortSignal.timeout(15000)
          });

          if (playersResponse.ok) {
            const playersData = await playersResponse.json();
            if (Array.isArray(playersData)) {
              players = playersData;
            }
            break;
          }
        } catch (error) {
          console.warn(`Failed to get players via ${corsProxy}:`, error);
          continue;
        }
      }

      // Create combined data structure
      const combinedData = {
        dynamic: serverInfo || {
          hostname: 'Unknown Server',
          clients: players.length,
          sv_maxclients: 'Unknown'
        },
        players: players
      };

      setServerData(combinedData);
      setSelectedPlayer(null);

      // Add to server history
      addToServerHistory(ip);

      // Calculate connection time and show success notification
      const endTime = Date.now();
      const connTime = connectionStartTime ? endTime - connectionStartTime : 0;
      setShowLoading(false);
      setServerStatus('online');
      const timeText = connTime < 1000 ? `${connTime}ms` : `${(connTime / 1000).toFixed(1)}s`;
      addNotification('success', `เชื่อมต่อสำเร็จ! พบผู้เล่นออนไลน์ ${players.length} คน (${timeText})`);



    } catch (error) {
      console.error('Error fetching server data:', error);

      let errorMessage = 'Unable to connect to server';

      if (error instanceof Error) {
        if (error.message.includes('timeout') || error.message.includes('AbortError')) {
          errorMessage = 'Connection timeout. Please try again.';
        } else if (error.message.includes('CORS')) {
          errorMessage = 'Server does not allow cross-origin requests';
        } else if (error.message.includes('Failed to fetch')) {
          errorMessage = 'Unable to connect to API. Please try again.';
        } else if (error.message.includes('Cannot fetch data from API')) {
          errorMessage = 'Server API is currently unavailable. Please check the server address and try again.';
        } else if (error.message.includes('Invalid server response')) {
          errorMessage = 'Server returned invalid data format. Please verify the server address.';
        } else {
          errorMessage = error.message;
        }
      }

      // Hide loading and show error notification
      setShowLoading(false);
      addNotification('error', errorMessage);
    }
  };

  const fetchServerData = async () => {
    if (!serverIp.trim()) {
      addNotification('error', 'กรุณาใส่ IP หรือ Domain ของเซิร์ฟเวอร์');
      return;
    }
    setShowLoading(true);
    setServerStatus('connecting');
    setConnectionStartTime(Date.now());

    try {
      const serverAddress = `${serverIp}:${serverPort}`;
      const corsProxies = [
        'https://corsproxy.io/?',
        'https://api.allorigins.win/raw?url='
      ];

      let serverInfo = null;
      let players = [];

      for (const corsProxy of corsProxies) {
        try {
          const infoUrl = corsProxy + encodeURIComponent('https://fivem-id.com/information');

          const infoResponse = await fetch(infoUrl, {
            method: 'POST',
            headers: {
              'Accept': 'application/json, text/javascript, */*; q=0.01',
              'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
              'Origin': 'https://fivem-id.com',
              'Referer': 'https://fivem-id.com/',
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36'
            },
            body: `server=${encodeURIComponent(serverAddress)}`,
            signal: AbortSignal.timeout(15000)
          });

          if (infoResponse.ok) {
            serverInfo = await infoResponse.json();
            break;
          }
        } catch (error) {
          console.warn(`Failed to get server info via ${corsProxy}:`, error);
          continue;
        }
      }

      // Try to get players data
      for (const corsProxy of corsProxies) {
        try {
          const playersUrl = corsProxy + encodeURIComponent('https://fivem-id.com/ajax');

          const playersResponse = await fetch(playersUrl, {
            method: 'POST',
            headers: {
              'Accept': 'application/json, text/javascript, */*; q=0.01',
              'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
              'Origin': 'https://fivem-id.com',
              'Referer': 'https://fivem-id.com/',
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/141.0.0.0 Safari/537.36'
            },
            body: `server=${encodeURIComponent(serverAddress)}`,
            signal: AbortSignal.timeout(15000)
          });

          if (playersResponse.ok) {
            const playersData = await playersResponse.json();
            if (Array.isArray(playersData)) {
              players = playersData;
            }
            break;
          }
        } catch (error) {
          console.warn(`Failed to get players via ${corsProxy}:`, error);
          continue;
        }
      }

      // Create combined data structure
      const combinedData = {
        dynamic: serverInfo || {
          hostname: 'Unknown Server',
          clients: players.length,
          sv_maxclients: 'Unknown'
        },
        players: players
      };

      setServerData(combinedData);
      setSelectedPlayer(null);

      // Add to server history
      addToServerHistory(serverIp);

      // Calculate connection time and show success notification
      const endTime = Date.now();
      const connTime = connectionStartTime ? endTime - connectionStartTime : 0;
      setShowLoading(false);
      setServerStatus('online');
      const timeText = connTime < 1000 ? `${connTime}ms` : `${(connTime / 1000).toFixed(1)}s`;
      addNotification('success', `เชื่อมต่อสำเร็จ! พบผู้เล่นออนไลน์ ${players.length} คน (${timeText})`);



    } catch (error) {
      console.error('Error fetching server data:', error);

      let errorMessage = 'Unable to connect to server';

      if (error instanceof Error) {
        if (error.message.includes('timeout') || error.message.includes('AbortError')) {
          errorMessage = 'Connection timeout. Please try again.';
        } else if (error.message.includes('CORS')) {
          errorMessage = 'Server does not allow cross-origin requests';
        } else if (error.message.includes('Failed to fetch')) {
          errorMessage = 'Unable to connect to API. Please try again.';
        } else if (error.message.includes('Cannot fetch data from API')) {
          errorMessage = 'Server API is currently unavailable. Please check the server address and try again.';
        } else if (error.message.includes('Invalid server response')) {
          errorMessage = 'Server returned invalid data format. Please verify the server address.';
        } else {
          errorMessage = error.message;
        }
      }

      // Hide loading and show error notification
      setShowLoading(false);
      addNotification('error', errorMessage);
    }
  };

  const handlePlayerClick = (player: PlayerWithDiscord) => {
    setSelectedPlayer(player);
  };

  // Handle ID input validation
  const handleSearchIdChange = (value: string) => {
    // Allow empty string
    if (value === '') {
      setSearchId('');
      setSearchIdError('');
      return;
    }

    // Check if the value contains only numbers
    const isNumeric = /^\d+$/.test(value);

    if (isNumeric) {
      setSearchId(value);
      setSearchIdError('');
    } else {
      setSearchIdError('กรุณาใส่เฉพาะตัวเลขเท่านั้น');
      // Don't update searchId if invalid, keep the previous valid value
    }
  };



  // Status Indicator Component
  const StatusIndicator = () => {
    const getStatusConfig = () => {
      switch (serverStatus) {
        case 'online':
          return {
            color: 'bg-green-500',
            text: 'Online',
            textColor: 'text-green-700 dark:text-green-300',
            bgColor: 'bg-green-50 dark:bg-green-900/20',
            borderColor: 'border-green-200 dark:border-green-700',

          };
        case 'connecting':
          return {
            color: 'bg-yellow-500 animate-pulse',
            text: 'Connecting',
            textColor: 'text-yellow-700 dark:text-yellow-300',
            bgColor: 'bg-yellow-50 dark:bg-yellow-900/20',
            borderColor: 'border-yellow-200 dark:border-yellow-700',

          };
        case 'error':
          return {
            color: 'bg-red-500',
            text: 'Error',
            textColor: 'text-red-700 dark:text-red-300',
            bgColor: 'bg-red-50 dark:bg-red-900/20',
            borderColor: 'border-red-200 dark:border-red-700',

          };
        default:
          return {
            color: 'bg-slate-400',
            text: 'Offline',
            textColor: 'text-slate-600 dark:text-slate-400',
            bgColor: 'bg-slate-50 dark:bg-slate-800',
            borderColor: 'border-slate-200 dark:border-slate-600',

          };
      }
    };

    const config = getStatusConfig();

    return (
      <div className={`inline-flex items-center space-x-2 px-3 py-1.5 rounded-full border ${config.bgColor} ${config.borderColor}`}>
        <div className={`w-2.5 h-2.5 rounded-full ${config.color}`}></div>
        <span className={`text-xs font-medium ${config.textColor}`}>
          {config.text}
        </span>

      </div>
    );
  };

  // Ping Distribution Chart Component
  const PingDistributionChart = () => {
    const pingRanges = useMemo(() => {
      if (!allPlayers.length) return [];

      const ranges = [
        { label: 'Excellent', min: 0, max: 30, color: 'bg-green-500', count: 0 },
        { label: 'Good', min: 31, max: 60, color: 'bg-blue-500', count: 0 },
        { label: 'Fair', min: 61, max: 100, color: 'bg-yellow-500', count: 0 },
        { label: 'Poor', min: 101, max: 200, color: 'bg-orange-500', count: 0 },
        { label: 'Bad', min: 201, max: Infinity, color: 'bg-red-500', count: 0 }
      ];

      allPlayers.forEach(player => {
        const range = ranges.find(r => player.ping >= r.min && player.ping <= r.max);
        if (range) range.count++;
      });

      return ranges.filter(r => r.count > 0);
    }, [allPlayers]);

    // Remove maxCount calculation since we want percentage-based bars

    if (!pingRanges.length) return null;

    return (
      <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
        <h3 className="text-lg font-semibold text-slate-900 dark:text-white mb-5 flex items-center">
          <svg className="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
          Ping Distribution
        </h3>
        <div className="space-y-4">
          {pingRanges.map((range, index) => {
            const percentage = ((range.count / allPlayers.length) * 100);
            return (
              <div key={index} className="flex items-center space-x-4">
                <div className="w-20 text-sm text-slate-700 dark:text-slate-300 font-medium">
                  {range.label}
                </div>
                <div className="flex-1 bg-slate-100 dark:bg-slate-700 rounded-full h-7 relative overflow-hidden">
                  <div
                    className={`${range.color} h-full rounded-full transition-all duration-700 ease-out relative`}
                    style={{ width: `${percentage}%` }}
                  >
                    <div className="absolute inset-0 bg-white/20 rounded-full"></div>
                  </div>
                </div>
                <div className="w-12 text-sm text-slate-600 dark:text-slate-400 text-right font-medium">
                  {percentage.toFixed(0)}%
                </div>
              </div>
            );
          })}
        </div>

        {/* Total Summary */}
        <div className="mt-5 pt-4 border-t border-slate-200 dark:border-slate-700">
          <div className="flex justify-between items-center text-sm">
            <span className="text-slate-600 dark:text-slate-400">Total Players</span>
            <span className="font-semibold text-slate-900 dark:text-white">{allPlayers.length}</span>
          </div>
        </div>
      </div>
    );
  };

  // Loading Indicator Component
  const LoadingIndicator = () => (
    <div className="fixed top-4 right-4 z-50">
      <div className="bg-white dark:bg-slate-800 rounded-lg shadow-lg p-4 flex items-center space-x-3 border border-slate-200 dark:border-slate-700">
        <div className="w-5 h-5 border-2 border-blue-600 border-t-transparent rounded-full animate-spin-smooth"></div>
        <span className="text-sm font-medium text-slate-700 dark:text-slate-300">Connecting...</span>
      </div>
    </div>
  );

  // Notification Component
  const NotificationList = () => (
    <div className="fixed bottom-4 right-4 z-50 space-y-3">
      {notifications.map((notification) => (
        <div
          key={notification.id}
          className={`max-w-md rounded-xl shadow-2xl p-4 flex items-start space-x-3 border backdrop-blur-sm animate-in slide-in-from-right duration-500 ${notification.type === 'success'
            ? 'bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/90 dark:to-emerald-900/90 border-green-300 dark:border-green-600'
            : 'bg-gradient-to-r from-red-50 to-rose-50 dark:from-red-900/90 dark:to-rose-900/90 border-red-300 dark:border-red-600'
            }`}
        >
          <div className={`flex-shrink-0 p-2 rounded-full ${notification.type === 'success'
            ? 'bg-green-100 dark:bg-green-800'
            : 'bg-red-100 dark:bg-red-800'
            }`}>
            {notification.type === 'success' ? (
              <svg className="w-5 h-5 text-green-600 dark:text-green-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M5 13l4 4L19 7" />
              </svg>
            ) : (
              <svg className="w-5 h-5 text-red-600 dark:text-red-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M6 18L18 6M6 6l12 12" />
              </svg>
            )}
          </div>
          <div className="flex-1 min-w-0">
            <p className={`text-sm font-semibold leading-relaxed ${notification.type === 'success'
              ? 'text-green-900 dark:text-green-100'
              : 'text-red-900 dark:text-red-100'
              }`}>
              {notification.message}
            </p>
          </div>
          <button
            onClick={() => removeNotification(notification.id)}
            className={`flex-shrink-0 rounded-full p-1.5 transition-all duration-200 hover:scale-110 ${notification.type === 'success'
              ? 'text-green-500 hover:bg-green-200 dark:text-green-400 dark:hover:bg-green-700'
              : 'text-red-500 hover:bg-red-200 dark:text-red-400 dark:hover:bg-red-700'
              }`}
          >
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      ))}
    </div>
  );



  // Edit Server Modal Component
  const EditServerModal = () => (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4">
      <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl w-full max-w-md">
        <div className="p-6">
          <div className="flex items-center justify-between mb-6">
            <h3 className="text-xl font-semibold text-slate-900 dark:text-white">
              แก้ไขเซิร์ฟเวอร์
            </h3>
            <button
              onClick={cancelEdit}
              className="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300"
            >
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>

          <div className="space-y-4">
            {/* Server Name */}
            <div>
              <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                ชื่อเซิร์ฟเวอร์
              </label>
              <input
                ref={nameInputRef}
                key="server-name-input"
                type="text"
                value={editName}
                onChange={(e) => setEditName(e.target.value)}
                placeholder="เช่น Startown2.0, What City"
                autoFocus
                className="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg
                         bg-white dark:bg-slate-700 text-slate-900 dark:text-white
                         focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>

            {/* Logo Type Selection */}
            <div>
              <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                ประเภทโลโก้
              </label>
              <div className="grid grid-cols-2 gap-3">
                <button
                  onClick={() => setLogoType('url')}
                  className={`relative p-4 rounded-xl border-2 transition-all duration-200 ${logoType === 'url'
                    ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20'
                    : 'border-slate-200 dark:border-slate-600 hover:border-slate-300 dark:hover:border-slate-500'
                    }`}
                >
                  <div className="flex flex-col items-center space-y-2">
                    <div className={`p-2 rounded-lg ${logoType === 'url'
                      ? 'bg-blue-100 dark:bg-blue-800'
                      : 'bg-slate-100 dark:bg-slate-700'
                      }`}>
                      <svg className={`w-5 h-5 ${logoType === 'url'
                        ? 'text-blue-600 dark:text-blue-400'
                        : 'text-slate-500 dark:text-slate-400'
                        }`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                      </svg>
                    </div>
                    <div className="text-center">
                      <div className={`font-medium text-sm ${logoType === 'url'
                        ? 'text-blue-700 dark:text-blue-300'
                        : 'text-slate-700 dark:text-slate-300'
                        }`}>
                        URL ลิงก์
                      </div>
                      <div className="text-xs text-slate-500 dark:text-slate-400">
                        ใช้ลิงก์รูปภาพ
                      </div>
                    </div>
                  </div>
                  {logoType === 'url' && (
                    <div className="absolute -top-1 -right-1 w-5 h-5 bg-blue-500 rounded-full flex items-center justify-center">
                      <svg className="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                      </svg>
                    </div>
                  )}
                </button>

                <button
                  onClick={() => setLogoType('file')}
                  className={`relative p-4 rounded-xl border-2 transition-all duration-200 ${logoType === 'file'
                    ? 'border-blue-500 bg-blue-50 dark:bg-blue-900/20'
                    : 'border-slate-200 dark:border-slate-600 hover:border-slate-300 dark:hover:border-slate-500'
                    }`}
                >
                  <div className="flex flex-col items-center space-y-2">
                    <div className={`p-2 rounded-lg ${logoType === 'file'
                      ? 'bg-blue-100 dark:bg-blue-800'
                      : 'bg-slate-100 dark:bg-slate-700'
                      }`}>
                      <svg className={`w-5 h-5 ${logoType === 'file'
                        ? 'text-blue-600 dark:text-blue-400'
                        : 'text-slate-500 dark:text-slate-400'
                        }`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                      </svg>
                    </div>
                    <div className="text-center">
                      <div className={`font-medium text-sm ${logoType === 'file'
                        ? 'text-blue-700 dark:text-blue-300'
                        : 'text-slate-700 dark:text-slate-300'
                        }`}>
                        อัพโหลดไฟล์
                      </div>
                      <div className="text-xs text-slate-500 dark:text-slate-400">
                        เลือกไฟล์รูปภาพ
                      </div>
                    </div>
                  </div>
                  {logoType === 'file' && (
                    <div className="absolute -top-1 -right-1 w-5 h-5 bg-blue-500 rounded-full flex items-center justify-center">
                      <svg className="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                      </svg>
                    </div>
                  )}
                </button>
              </div>
            </div>

            {/* Logo Input */}
            <div>
              <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                โลโก้
              </label>

              {logoType === 'url' && (
                <input
                  key="logo-url-input"
                  type="url"
                  value={editLogo}
                  onChange={(e) => setEditLogo(e.target.value)}
                  placeholder="https://example.com/logo.png"
                  className="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg
                           bg-white dark:bg-slate-700 text-slate-900 dark:text-white
                           focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              )}
              {logoType === 'file' && (
                <div className="space-y-2">
                  <input
                    type="file"
                    accept="image/*"
                    onChange={handleFileUpload}
                    className="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg
                             bg-white dark:bg-slate-700 text-slate-900 dark:text-white
                             focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                  {editLogo && editLogo.startsWith('data:') && (
                    <div className="flex justify-center">
                      <img
                        src={editLogo}
                        alt="Preview"
                        className="w-16 h-16 object-cover rounded-lg border border-slate-300 dark:border-slate-600"
                      />
                    </div>
                  )}
                </div>
              )}
            </div>

            {/* Preview */}
            {(editName || editLogo) && (
              <div>
                <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                  ตัวอย่าง
                </label>
                <div className="bg-slate-50 dark:bg-slate-700 rounded-lg border border-slate-200 dark:border-slate-600 p-3">
                  <div className="flex items-center space-x-2">
                    <div className="flex-shrink-0">
                      {editLogo ? (
                        <img
                          src={editLogo}
                          alt="Logo"
                          className="w-6 h-6 object-cover rounded"
                          onError={(e) => {
                            e.currentTarget.style.display = 'none';
                          }}
                        />
                      ) : (
                        <span className="text-lg">🌐</span>
                      )}
                    </div>
                    <div className="flex-1 min-w-0">
                      <div className="font-medium text-slate-900 dark:text-white truncate">
                        {editName || editingServer?.address}
                      </div>
                      {editName && (
                        <div className="text-xs text-slate-500 dark:text-slate-400 truncate">
                          {editingServer?.address}
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* Actions */}
          <div className="flex space-x-3 mt-6">
            <button
              onClick={cancelEdit}
              className="flex-1 bg-slate-500 hover:bg-slate-600 text-white font-medium py-2 px-4 rounded-lg"
            >
              ยกเลิก
            </button>
            <button
              onClick={saveServerEdit}
              className="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg"
            >
              บันทึก
            </button>
          </div>
        </div>
      </div>
    </div>
  );

  // Settings Dropdown Component - Memoized to prevent flickering
  const SettingsDropdown = useCallback(() => (
    <div className="absolute top-full right-0 mt-2 w-56 bg-white dark:bg-slate-800 rounded-lg shadow-lg border border-slate-200 dark:border-slate-700 z-50 settings-dropdown">
      <div className="p-3">
        <div className="text-xs font-medium text-slate-500 dark:text-slate-400 mb-2">Theme</div>
        <div className="space-y-1">
          <button
            onClick={() => handleThemeChange('light')}
            className={`w-full flex items-center space-x-2 px-3 py-2 text-sm rounded-md ${currentTheme === 'light'
              ? 'bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300'
              : 'text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700'
              }`}
          >
            <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fillRule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clipRule="evenodd" />
            </svg>
            <span>Light</span>
          </button>

          <button
            onClick={() => handleThemeChange('dark')}
            className={`w-full flex items-center space-x-2 px-3 py-2 text-sm rounded-md ${currentTheme === 'dark'
              ? 'bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300'
              : 'text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700'
              }`}
          >
            <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" />
            </svg>
            <span>Dark</span>
          </button>
        </div>


      </div>
    </div>
  ), [currentTheme, handleThemeChange]);


  /*
  const LoadingModal = () => {

    const icons = ['🔌', '�,', '✅', '�'];

    return (
      <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
        <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
          <div className="text-center">
            <div className="mb-6">
              <div className="inline-flex items-center justify-center w-16 h-16 bg-blue-100 dark:bg-blue-900 rounded-full mb-4">
                <div className="w-8 h-8 border-3 border-blue-600 border-t-transparent rounded-full animate-spin-smooth"></div>
              </div>
              <h3 className="text-xl font-semibold text-slate-900 dark:text-white mb-2">
                Connecting to Server
              </h3>
              <p className="text-slate-600 dark:text-slate-400">
                Please wait while we fetch the server data...
              </p>
            </div>


          </div>
        </div>
      </div>
    );
  };

  const SuccessModal = () => (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
      <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
        <div className="text-center">
          <div className="inline-flex items-center justify-center w-16 h-16 bg-green-100 dark:bg-green-900 rounded-full mb-4">
            <svg className="w-8 h-8 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
            </svg>
          </div>
          <h3 className="text-xl font-semibold text-slate-900 dark:text-white mb-2">
            Connection Successful!
          </h3>
          <p className="text-slate-600 dark:text-slate-400 mb-6">
            {modalMessage}
          </p>
          <button
            onClick={() => setShowSuccessModal(false)}
            className="bg-green-600 hover:bg-green-700 active:bg-green-800 text-white font-medium py-2 px-6 rounded-lg"
          >
            Continue
          </button>
        </div>
      </div>
    </div>
  );

  const ErrorModal = () => (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
      <div className="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
        <div className="text-center">
          <div className="inline-flex items-center justify-center w-16 h-16 bg-red-100 dark:bg-red-900 rounded-full mb-4">
            <svg className="w-8 h-8 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </div>
          <h3 className="text-xl font-semibold text-slate-900 dark:text-white mb-2">
            Connection Failed
          </h3>
          <p className="text-slate-600 dark:text-slate-400 mb-6">
            {modalMessage}
          </p>
          <button
            onClick={() => setShowErrorModal(false)}
            className="bg-red-600 hover:bg-red-700 active:bg-red-800 text-white font-medium py-2 px-6 rounded-lg"
          >
            Try Again
          </button>
        </div>
      </div>
    </div>
  );
  */



  return (
    <ThemeProvider theme={muiTheme}>
      <div className="min-h-screen bg-slate-50 dark:bg-slate-900 hide-scrollbar">

        {/* Welcome Banner for Shared Links */}
        {isSharedLink && (
          <div className="bg-gradient-to-r from-blue-600 to-green-600 text-white">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
              <div className="flex items-center justify-between">
                <div className="flex items-center space-x-3">
                  <div className="flex-shrink-0">
                    <ShareIcon sx={{ fontSize: 20 }} />
                  </div>
                  <div>
                    <p className="text-sm font-medium">
                      คุณได้รับลิงก์แชร์เซิร์ฟเวอร์ FiveM!
                    </p>
                    {sharedFromUser && (
                      <p className="text-xs opacity-90">
                        แชร์โดย: {sharedFromUser}
                      </p>
                    )}
                  </div>
                </div>
                <button
                  onClick={() => setIsSharedLink(false)}
                  className="text-white/80 hover:text-white transition-colors"
                >
                  <CloseIcon sx={{ fontSize: 18 }} />
                </button>
              </div>
            </div>
          </div>
        )}

        {/* OAuth Help Banner */}
        {showOAuthHelp && (
          <div className="bg-gradient-to-r from-orange-500 to-red-500 text-white">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
              <div className="flex items-center justify-between">
                <div className="flex items-center space-x-3">
                  <div className="flex-shrink-0">
                    <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                      <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                    </svg>
                  </div>
                  <div>
                    <p className="text-sm font-medium">
                      Discord OAuth Issue Detected
                    </p>
                    <p className="text-xs opacity-90">
                      The authorization code may be expired or invalid. Try clearing the URL and logging in again.
                    </p>
                  </div>
                </div>
                <div className="flex items-center space-x-2">
                  <button
                    onClick={clearUrlAndRetry}
                    className="text-xs bg-white/20 hover:bg-white/30 px-3 py-1 rounded-md transition-colors"
                  >
                    Clear & Retry
                  </button>
                  <button
                    onClick={() => setShowOAuthHelp(false)}
                    className="text-white/80 hover:text-white transition-colors"
                  >
                    <CloseIcon sx={{ fontSize: 18 }} />
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Header */}
        <header className="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 shadow-sm">
          <div className="max-w-7xl mx-auto px-3 sm:px-4 md:px-6 lg:px-8">
            <div className="flex justify-between items-center h-16 sm:h-18">
              <div className="flex flex-col sm:flex-row sm:items-center sm:space-x-4">
                <div className="flex items-center space-x-3">
                  <div className="w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                    <svg className="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                  </div>
                  <div>
                    <h1 className="text-lg sm:text-xl font-bold text-slate-900 dark:text-white">
                      FiveM Monitor
                    </h1>
                    <p className="text-xs text-slate-500 dark:text-slate-400 hidden sm:block">
                      Professional Server Monitoring
                    </p>
                  </div>
                </div>
                <div className="mt-2 sm:mt-0">
                  <StatusIndicator />
                </div>
              </div>

              <div className="flex items-center space-x-3">
                {/* Discord Login */}
                {discordUser ? (
                  <div className="flex items-center space-x-2 bg-indigo-50 dark:bg-indigo-900/20 px-3 py-2 rounded-lg border border-indigo-200 dark:border-indigo-700">
                    <img
                      src={discordUser.avatar_url || `https://cdn.discordapp.com/embed/avatars/${parseInt(discordUser.discriminator || '0') % 5}.png`}
                      alt="Discord Avatar"
                      className="w-6 h-6 rounded-full"
                      onError={(e) => {
                        e.currentTarget.src = `https://cdn.discordapp.com/embed/avatars/${parseInt(discordUser.discriminator || '0') % 5}.png`;
                      }}
                    />
                    <span className="text-sm font-medium text-indigo-700 dark:text-indigo-300">
                      {discordUser.global_name || discordUser.username}
                    </span>

                    <button
                      onClick={logoutDiscord}
                      className="text-indigo-500 hover:text-indigo-700 dark:text-indigo-400 dark:hover:text-indigo-300"
                      title="Logout"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                      </svg>
                    </button>
                  </div>
                ) : (
                  <button
                    onClick={loginWithDiscord}
                    disabled={isDiscordLoading}
                    className="flex items-center space-x-2 bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-400 text-white px-4 py-2 rounded-lg transition-colors"
                  >
                    {isDiscordLoading ? (
                      <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin-smooth"></div>
                    ) : (
                      <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z" />
                      </svg>
                    )}
                    <span className="text-sm font-medium">Discord</span>
                  </button>
                )}

                <div className="relative" data-settings-dropdown>
                  <button
                    onClick={handleSettingsToggle}
                    className="p-2 rounded-lg text-slate-500 hover:text-slate-700 hover:bg-slate-100 dark:text-slate-400 dark:hover:text-slate-300 dark:hover:bg-slate-700"
                  >
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                  </button>
                  {showSettingsModal && SettingsDropdown()}
                </div>
              </div>
            </div>
          </div>
        </header>

        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8 lg:py-10">
          <div className="grid grid-cols-1 xl:grid-cols-12 gap-6 lg:gap-8">

            {/* Sidebar */}
            <div className="xl:col-span-4 space-y-6">
              {/* Server Connection */}
              <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-6">
                <h2 className="text-lg font-semibold text-slate-900 dark:text-white mb-5 flex items-center">
                  <svg className="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0" />
                  </svg>
                  Server Connection
                </h2>

                <div className="space-y-5">
                  <div>
                    <label className="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">
                      Server Address
                    </label>
                    <input
                      type="text"
                      value={serverIp}
                      onChange={(e) => setServerIp(e.target.value)}
                      onKeyDown={(e) => e.key === 'Enter' && fetchServerData()}
                      className="w-full px-3 py-2.5 sm:py-2 border border-slate-300 dark:border-slate-600 rounded-lg 
                             bg-white dark:bg-slate-700 text-slate-900 dark:text-white text-sm sm:text-base
                             focus:ring-2 focus:ring-blue-500 focus:border-transparent
                             placeholder-slate-400 dark:placeholder-slate-500"
                      placeholder="เช่น play.st20.app or 127.0.0.1"
                      autoFocus
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">
                      Port
                    </label>
                    <input
                      type="number"
                      value={serverPort}
                      onChange={(e) => setServerPort(e.target.value)}
                      onKeyDown={(e) => e.key === 'Enter' && fetchServerData()}
                      className="w-full px-3 py-2.5 sm:py-2 border border-slate-300 dark:border-slate-600 rounded-lg 
                             bg-white dark:bg-slate-700 text-slate-900 dark:text-white text-sm sm:text-base
                             focus:ring-2 focus:ring-blue-500 focus:border-transparent
                             placeholder-slate-400 dark:placeholder-slate-500"
                      placeholder="30120"
                      min="1"
                      max="65535"
                    />
                  </div>

                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <button
                      onClick={fetchServerData}
                      disabled={serverStatus === 'connecting'}
                      className="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 disabled:from-blue-400 disabled:to-blue-500 text-white font-semibold py-3 px-6 rounded-lg focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-200 shadow-lg hover:shadow-xl disabled:cursor-not-allowed flex items-center justify-center space-x-2"
                    >
                      {serverStatus === 'connecting' ? (
                        <>
                          <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin-smooth"></div>
                          <span>Connecting...</span>
                        </>
                      ) : (
                        <>
                          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                          </svg>
                          <span>Connect</span>
                        </>
                      )}
                    </button>
                    <button
                      onClick={generateShareUrl}
                      className="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-semibold py-3 px-6 rounded-lg focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-all duration-200 shadow-lg hover:shadow-xl flex items-center justify-center space-x-2 w-full"
                    >
                      <ShareIcon sx={{ fontSize: 16 }} />
                      <span>Share</span>
                    </button>
                  </div>

                  {/* Server History */}
                  {serverHistory.length > 0 && (
                    <div className="mt-3 sm:mt-4">
                      <div className="flex items-center justify-between mb-2">
                        <label className="block text-xs sm:text-sm font-medium text-slate-700 dark:text-slate-300">
                          📋 เซิร์ฟเวอร์ล่าสุด
                        </label>
                        <button
                          onClick={clearAllHistory}
                          className="text-xs text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 px-2 py-1"
                        >
                          ลบทั้งหมด
                        </button>
                      </div>
                      <div className="space-y-2">
                        {serverHistory.map((historyItem, index) => (
                          <div
                            key={index}
                            className="bg-slate-50 dark:bg-slate-700 rounded-lg border border-slate-200 dark:border-slate-600"
                          >
                            <div className="flex items-center">
                              <button
                                onClick={() => selectFromHistory(historyItem)}
                                className="flex-1 flex items-center space-x-3 px-3 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-600 rounded-l-lg
                                       text-slate-700 dark:text-slate-300"
                              >
                                <div className="flex-shrink-0">
                                  {historyItem.logo ? (
                                    historyItem.logo.startsWith('http') || historyItem.logo.startsWith('data:') ? (
                                      <img
                                        src={historyItem.logo}
                                        alt="Server Logo"
                                        className="w-6 h-6 object-cover rounded"
                                        onError={(e) => {
                                          e.currentTarget.style.display = 'none';
                                          const fallback = e.currentTarget.nextElementSibling as HTMLElement;
                                          if (fallback) fallback.style.display = 'inline';
                                        }}
                                      />
                                    ) : (
                                      <span className="text-lg">{historyItem.logo}</span>
                                    )
                                  ) : (
                                    <span className="text-lg">🌐</span>
                                  )}
                                  <span className="text-lg hidden">🌐</span>
                                </div>
                                <div className="flex-1 text-left min-w-0">
                                  <div className="font-medium truncate">
                                    {historyItem.customName || historyItem.address}
                                  </div>
                                  {historyItem.customName && (
                                    <div className="text-xs text-slate-500 dark:text-slate-400 truncate">
                                      {historyItem.address}
                                    </div>
                                  )}
                                </div>
                              </button>
                              <button
                                onClick={() => startEditingServer(historyItem)}
                                className="px-2 py-2 text-blue-500 hover:text-blue-700 hover:bg-blue-50 dark:hover:bg-blue-900"
                                title="แก้ไขชื่อและโลโก้"
                              >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                              </button>
                              <button
                                onClick={() => removeFromHistory(historyItem)}
                                className="px-2 py-2 text-red-500 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-900 rounded-r-lg"
                                title="ลบออกจากรายการ"
                              >
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                </svg>
                              </button>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              </div>

              {/* Server Info */}
              <div className="bg-white dark:bg-slate-800 rounded-lg sm:rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-3 sm:p-4 md:p-6">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-medium text-slate-900 dark:text-white">
                    ข้อมูลเซิร์ฟเวอร์
                  </h3>
                  {serverData && (
                    <Tooltip title="แชร์ข้อมูลเซิร์ฟเวอร์นี้">
                      <IconButton
                        onClick={generateShareUrl}
                        size="small"
                        sx={{
                          color: '#10b981',
                          '&:hover': {
                            bgcolor: currentTheme === 'dark' ? '#065f46' : '#d1fae5'
                          }
                        }}
                      >
                        <ShareIcon fontSize="small" />
                      </IconButton>
                    </Tooltip>
                  )}
                </div>

                {serverData?.dynamic ? (
                  <div className="space-y-4">
                    {/* Server Status Card */}
                    <div className="bg-gradient-to-r from-green-50 to-blue-50 dark:from-green-900/20 dark:to-blue-900/20 rounded-lg p-4 border border-green-200 dark:border-green-700">
                      <div className="flex items-center space-x-3 mb-3">
                        <div className="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                        <h4 className="font-semibold text-green-800 dark:text-green-200">Server Online</h4>
                      </div>
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                        <div className="space-y-1">
                          <div className="text-slate-600 dark:text-slate-400 text-xs">Server</div>
                          <div className="font-medium text-slate-900 dark:text-white break-all">{serverIp}:{serverPort}</div>
                        </div>
                        <div className="space-y-1">
                          <div className="text-slate-600 dark:text-slate-400 text-xs">Players</div>
                          <div className="font-medium text-slate-900 dark:text-white">
                            {serverData.dynamic.clients || 0}/{serverData.dynamic.sv_maxclients || 'Unknown'}
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* Server Details */}
                    <div className="bg-slate-50 dark:bg-slate-900 rounded-lg p-6">
                      <h4 className="font-semibold text-slate-900 dark:text-white mb-4 flex items-center">
                        <svg className="w-5 h-5 mr-3 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Server Information
                      </h4>
                      <div className="space-y-4">
                        {serverData.dynamic.hostname && (
                          <div className="border-b border-slate-200 dark:border-slate-700 pb-3">
                            <div className="text-sm text-slate-600 dark:text-slate-400 mb-1">Hostname</div>
                            <div className="font-medium text-slate-900 dark:text-white break-words">
                              {serverData.dynamic.hostname}
                            </div>
                          </div>
                        )}

                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                          {serverData.dynamic.gametype && (
                            <div>
                              <div className="text-sm text-slate-600 dark:text-slate-400 mb-1">Game Type</div>
                              <div className="font-medium text-slate-900 dark:text-white">{serverData.dynamic.gametype}</div>
                            </div>
                          )}
                          {serverData.dynamic.mapname && (
                            <div>
                              <div className="text-sm text-slate-600 dark:text-slate-400 mb-1">Map</div>
                              <div className="font-medium text-slate-900 dark:text-white">{serverData.dynamic.mapname}</div>
                            </div>
                          )}
                          {serverData.dynamic.version && (
                            <div>
                              <div className="text-sm text-slate-600 dark:text-slate-400 mb-1">Version</div>
                              <div className="font-medium text-slate-900 dark:text-white">{serverData.dynamic.version}</div>
                            </div>
                          )}
                          {serverData.dynamic.enhancedHostSupport !== undefined && (
                            <div>
                              <div className="text-sm text-slate-600 dark:text-slate-400 mb-1">Enhanced Host</div>
                              <div className={`font-medium ${serverData.dynamic.enhancedHostSupport ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>
                                {serverData.dynamic.enhancedHostSupport ? 'Enabled' : 'Disabled'}
                              </div>
                            </div>
                          )}
                        </div>

                        {serverData.dynamic.licenseKeyToken && (
                          <div className="mt-4 pt-3 border-t border-slate-200 dark:border-slate-700">
                            <div className="flex items-center space-x-2">
                              <svg className="w-4 h-4 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                              </svg>
                              <span className="text-sm font-medium text-green-600 dark:text-green-400">Licensed Server</span>
                            </div>
                          </div>
                        )}
                      </div>
                    </div>

                    {/* Resources */}
                    {serverData.dynamic.resources && serverData.dynamic.resources.length > 0 && (
                      <div className="bg-slate-50 dark:bg-slate-900 rounded-lg p-6">
                        <h4 className="font-semibold text-slate-900 dark:text-white mb-4 flex items-center">
                          <svg className="w-5 h-5 mr-3 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14-7H5a2 2 0 00-2 2v12a2 2 0 002 2h14a2 2 0 002-2V6a2 2 0 00-2-2z" />
                          </svg>
                          Server Resources
                          <span className="ml-2 px-2 py-1 bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200 text-xs font-medium rounded-full">
                            {serverData.dynamic.resources.length}
                          </span>
                        </h4>
                        <div className="max-h-40 overflow-y-auto hide-scrollbar">
                          <div className="flex flex-wrap gap-2">
                            {serverData.dynamic.resources.slice(0, 25).map((resource: string, index: number) => (
                              <span
                                key={index}
                                className="inline-flex items-center px-3 py-1 rounded-md text-xs font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 border border-blue-200 dark:border-blue-700"
                              >
                                {resource}
                              </span>
                            ))}
                            {serverData.dynamic.resources.length > 25 && (
                              <span className="inline-flex items-center px-3 py-1 rounded-md text-xs font-medium bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-400 border border-slate-200 dark:border-slate-600">
                                +{serverData.dynamic.resources.length - 25} more resources
                              </span>
                            )}
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Variables */}
                    {serverData.dynamic.vars && Object.keys(serverData.dynamic.vars).length > 0 && (
                      <div className="bg-slate-50 dark:bg-slate-900 rounded-lg p-6">
                        <h4 className="font-semibold text-slate-900 dark:text-white mb-4 flex items-center">
                          <svg className="w-5 h-5 mr-3 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4" />
                          </svg>
                          Server Variables
                          <span className="ml-2 px-2 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 text-xs font-medium rounded-full">
                            {Object.keys(serverData.dynamic.vars).length}
                          </span>
                        </h4>
                        <div className="max-h-48 overflow-y-auto hide-scrollbar">
                          <div className="space-y-3">
                            {Object.entries(serverData.dynamic.vars).map(([key, value]: [string, any]) => (
                              <div key={key} className="bg-white dark:bg-slate-800 rounded-lg p-3 border border-slate-200 dark:border-slate-700">
                                <div className="text-xs text-slate-600 dark:text-slate-400 mb-1 font-mono">
                                  {key}
                                </div>
                                <div className="text-sm font-medium text-slate-900 dark:text-white break-words">
                                  {typeof value === 'string' ? value : JSON.stringify(value)}
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      </div>
                    )}


                  </div>
                ) : (
                  <div className="bg-slate-50 dark:bg-slate-900 rounded-lg p-8 text-center">
                    <svg className="mx-auto h-12 w-12 text-slate-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    <p className="text-slate-500 dark:text-slate-400">ไม่มีข้อมูลเซิร์ฟเวอร์</p>
                    <p className="text-xs text-slate-400 dark:text-slate-500 mt-1">กรุณาเชื่อมต่อเซิร์ฟเวอร์เพื่อดูข้อมูล</p>
                  </div>
                )}
              </div>

              {/* Ping Distribution Chart */}
              {allPlayers.length > 0 && <PingDistributionChart />}

              {/* Player Details */}
              <div className="bg-white dark:bg-slate-800 rounded-lg sm:rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 p-3 sm:p-4 md:p-6">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-medium text-slate-900 dark:text-white">
                    รายละเอียดผู้เล่น
                  </h3>
                  {selectedPlayer && (
                    <button
                      onClick={copyPlayerData}
                      className="p-2 rounded-lg text-slate-500 hover:text-slate-700 hover:bg-slate-100 dark:text-slate-400 dark:hover:text-slate-300 dark:hover:bg-slate-700 transition-colors"
                      title="คัดลอกข้อมูลผู้เล่น"
                    >
                      <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                      </svg>
                    </button>
                  )}
                </div>
                {selectedPlayer ? (
                  <div className="space-y-4">
                    {selectedPlayer.discordAvatar && (
                      <div className="flex justify-center">
                        <img
                          src={selectedPlayer.discordAvatar}
                          alt="Discord Avatar"
                          className="w-16 h-16 rounded-full border-2 border-slate-200 dark:border-slate-600"
                          onError={(e) => {
                            e.currentTarget.style.display = 'none';
                          }}
                        />
                      </div>
                    )}
                    <div className="space-y-2 text-sm">
                      <div className="flex justify-between">
                        <span className="text-slate-500 dark:text-slate-400">ID:</span>
                        <span className="font-medium text-slate-900 dark:text-white">{selectedPlayer.id}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-slate-500 dark:text-slate-400">Name:</span>
                        <span className="font-medium text-slate-900 dark:text-white">{selectedPlayer.name}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-slate-500 dark:text-slate-400">Ping:</span>
                        <span className={`font-medium ${selectedPlayer.ping < 50 ? 'text-green-600' :
                          selectedPlayer.ping < 100 ? 'text-yellow-600' : 'text-red-600'
                          }`}>
                          {selectedPlayer.ping}ms
                        </span>
                      </div>
                      {selectedPlayer.endpoint && !selectedPlayer.endpoint.startsWith('127.0.0.1') && (
                        <div className="flex justify-between">
                          <span className="text-slate-500 dark:text-slate-400">Endpoint:</span>
                          <span className="font-mono text-xs text-slate-900 dark:text-white">{selectedPlayer.endpoint}</span>
                        </div>
                      )}
                      {selectedPlayer.discordId && (
                        <div className="flex justify-between">
                          <span className="text-slate-500 dark:text-slate-400">Discord:</span>
                          <span className="font-mono text-xs text-slate-900 dark:text-white">{selectedPlayer.discordId}</span>
                        </div>
                      )}
                    </div>
                  </div>
                ) : (
                  <p className="text-slate-500 dark:text-slate-400 text-sm">
                    Click on a player to view details
                  </p>
                )}
              </div>
            </div>

            {/* Main Content */}
            <div className="xl:col-span-8">
              <div className="bg-white dark:bg-slate-800 rounded-lg sm:rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                <div className="p-3 sm:p-4 md:p-6 border-b border-slate-200 dark:border-slate-700" data-section="online-players">
                  {/* Server Header Card */}
                  {serverData && (
                    <div className="bg-gradient-to-r from-blue-50 to-green-50 dark:from-blue-900/20 dark:to-green-900/20 rounded-lg sm:rounded-xl p-3 sm:p-4 md:p-4 mb-4 sm:mb-6 border border-blue-200 dark:border-blue-700">
                      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-3 space-y-2 sm:space-y-0">
                        <div className="flex items-center space-x-2 sm:space-x-3">
                          <div className="w-2.5 h-2.5 sm:w-3 sm:h-3 bg-green-500 rounded-full animate-pulse"></div>
                          <h2 className="text-lg sm:text-xl font-bold text-slate-900 dark:text-white">
                            FiveM Player Search
                          </h2>
                        </div>
                        <div className="flex items-center space-x-2">
                          {isLoadingPlayers && (
                            <div className="w-4 h-4 sm:w-5 sm:h-5 border-2 border-blue-600 border-t-transparent rounded-full animate-spin-smooth"></div>
                          )}
                          <span className="bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-xs sm:text-sm font-medium px-2 sm:px-3 py-1 rounded-full">
                            {filteredPlayers.length} / {serverData?.players.length || 0} ผู้เล่น
                          </span>
                        </div>
                      </div>

                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 text-xs sm:text-sm">
                        <div className="bg-white/50 dark:bg-slate-800/50 rounded-lg p-2.5 sm:p-3">
                          <div className="flex items-center space-x-1.5 sm:space-x-2 mb-1">
                            <svg className="w-3.5 h-3.5 sm:w-4 sm:h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9v-9m0-9v9" />
                            </svg>
                            <span className="font-medium text-slate-700 dark:text-slate-300 text-xs sm:text-sm">Server</span>
                          </div>
                          <div className="text-slate-900 dark:text-white font-semibold text-sm sm:text-base break-all">
                            {serverIp}:{serverPort}
                          </div>
                          {customShareName && (
                            <div className="text-xs text-slate-500 dark:text-slate-400 mt-1 truncate">
                              {customShareName}
                            </div>
                          )}
                        </div>

                        <div className="bg-white/50 dark:bg-slate-800/50 rounded-lg p-2.5 sm:p-3">
                          <div className="flex items-center space-x-1.5 sm:space-x-2 mb-1">
                            <svg className="w-3.5 h-3.5 sm:w-4 sm:h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" />
                            </svg>
                            <span className="font-medium text-slate-700 dark:text-slate-300 text-xs sm:text-sm">Search Type</span>
                          </div>
                          <div className="text-slate-900 dark:text-white font-semibold text-sm sm:text-base">
                            {searchName.trim() ? 'Player Name' : searchId.trim() ? 'Player ID' : 'All Players'}
                          </div>
                          <div className="text-xs text-slate-500 dark:text-slate-400 mt-1 truncate">
                            {searchName.trim() || searchId.trim() || 'ทั้งหมด'}
                          </div>
                        </div>


                      </div>



                      {/* Data Integrity Hash */}
                      {playerDataHash && (
                        <div className="mt-4 pt-4 border-t border-blue-200 dark:border-blue-700">
                          <div className="bg-slate-50 dark:bg-slate-800/50 rounded-lg p-4 border border-slate-200 dark:border-slate-700">
                            <div className="flex items-start justify-between">
                              <div className="flex-1 min-w-0">
                                <div className="flex items-center space-x-2 mb-2">
                                  <svg className="w-4 h-4 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                                  </svg>
                                  <span className="text-sm font-medium text-slate-700 dark:text-slate-300">
                                    Data Integrity Hash
                                  </span>
                                  <span className="px-2 py-0.5 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-xs font-medium rounded-full">
                                    SHA-256
                                  </span>
                                </div>
                                <div className="bg-white dark:bg-slate-800 rounded-md p-3 border border-slate-200 dark:border-slate-600">
                                  <HashDisplay hash={playerDataHash} counter={hashCounter} />
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      )}


                    </div>
                  )}

                  <div className="flex items-center justify-between mb-4">
                    <h3 className="text-lg font-medium text-slate-900 dark:text-white">
                      Player List
                    </h3>
                    {filteredPlayers.length > 0 && (
                      <span className="bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 text-sm font-medium px-2.5 py-0.5 rounded-full">
                        Showing {((currentPage - 1) * playersPerPage) + 1}-{Math.min(currentPage * playersPerPage, filteredPlayers.length)} of {filteredPlayers.length}
                      </span>
                    )}
                  </div>

                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-4">
                    <div className="relative">
                      <input
                        type="text"
                        value={searchName}
                        onChange={(e) => {
                          setSearchName(e.target.value);
                          // Clear ID error when using name search
                          if (searchIdError) setSearchIdError('');
                        }}
                        className="w-full pl-9 sm:pl-10 pr-3 py-2.5 sm:py-2 border border-slate-300 dark:border-slate-600 rounded-lg 
                               bg-white dark:bg-slate-700 text-slate-900 dark:text-white text-sm sm:text-base
                               focus:ring-2 focus:ring-blue-500 focus:border-transparent
                               placeholder-slate-400 dark:placeholder-slate-500"
                        placeholder="Search by name..."
                      />
                      <div className="absolute inset-y-0 left-0 pl-2.5 sm:pl-3 flex items-center pointer-events-none">
                        <svg className="h-3.5 w-3.5 sm:h-4 sm:w-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                      </div>
                    </div>
                    <div className="relative">
                      <input
                        type="text"
                        value={searchId}
                        onChange={(e) => handleSearchIdChange(e.target.value)}
                        className={`w-full pl-9 sm:pl-10 pr-3 py-2.5 sm:py-2 border rounded-lg 
                               bg-white dark:bg-slate-700 text-slate-900 dark:text-white text-sm sm:text-base
                               focus:ring-2 focus:border-transparent
                               placeholder-slate-400 dark:placeholder-slate-500 ${searchIdError
                            ? 'border-red-300 dark:border-red-600 focus:ring-red-500'
                            : 'border-slate-300 dark:border-slate-600 focus:ring-blue-500'
                          }`}
                        placeholder="Search by ID..."
                      />
                      <div className="absolute inset-y-0 left-0 pl-2.5 sm:pl-3 flex items-center pointer-events-none">
                        <span className="text-slate-400 font-mono text-xs sm:text-sm">#</span>
                      </div>
                      {searchIdError && (
                        <div className="absolute top-full left-0 mt-1 text-xs text-red-600 dark:text-red-400">
                          {searchIdError}
                        </div>
                      )}
                    </div>
                  </div>
                </div>

                <div className="overflow-hidden">
                  <div className="max-h-[500px] sm:max-h-[600px] overflow-y-auto hide-scrollbar">
                    <table className="min-w-full divide-y divide-slate-200 dark:divide-slate-700" data-player-table>
                      <thead className="bg-slate-50 dark:bg-slate-900 sticky top-0">
                        <tr>
                          <th className="px-3 sm:px-6 py-2 sm:py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                            Player
                          </th>
                          <th className="px-3 sm:px-6 py-2 sm:py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                            ID
                          </th>
                          <th className="px-3 sm:px-6 py-2 sm:py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                            Ping
                          </th>
                        </tr>
                      </thead>
                      <tbody className="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
                        {isLoadingPlayers ? (
                          // Skeleton Loading Rows
                          [...Array(5)].map((_, i) => (
                            <tr key={i} className="animate-pulse">
                              <td className="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap">
                                <div className="flex items-center">
                                  <div className="flex-shrink-0 h-6 w-6 sm:h-8 sm:w-8 bg-slate-200 dark:bg-slate-700 rounded-full"></div>
                                  <div className="ml-2 sm:ml-4 min-w-0 flex-1">
                                    <div className="h-4 bg-slate-200 dark:bg-slate-700 rounded w-24"></div>
                                  </div>
                                </div>
                              </td>
                              <td className="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap">
                                <div className="h-6 bg-slate-200 dark:bg-slate-700 rounded-full w-12"></div>
                              </td>
                              <td className="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap">
                                <div className="h-6 bg-slate-200 dark:bg-slate-700 rounded-full w-16"></div>
                              </td>
                            </tr>
                          ))
                        ) : paginatedPlayers.length > 0 ? (
                          paginatedPlayers.map((player) => (
                            <tr
                              key={player.id}
                              onClick={() => handlePlayerClick(player)}
                              className={`cursor-pointer transition-colors ${selectedPlayer?.id === player.id
                                ? 'bg-blue-100 dark:bg-blue-900 border-l-4 border-blue-500'
                                : 'hover:bg-slate-50 dark:hover:bg-slate-700'
                                }`}
                            >
                              <td className="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap">
                                <div className="flex items-center">
                                  <div className="flex-shrink-0 h-6 w-6 sm:h-8 sm:w-8">
                                    {player.discordAvatar ? (
                                      <img
                                        className="h-6 w-6 sm:h-8 sm:w-8 rounded-full"
                                        src={player.discordAvatar}
                                        alt=""
                                        onError={(e) => {
                                          e.currentTarget.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiNEMUQ1REIiLz4KPHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4PSI4IiB5PSI4Ij4KPHBhdGggZD0iTTggMTJDMTAuMjA5MSAxMiAxMiAxMC4yMDkxIDEyIDhDMTIgNS43OTA5IDEwLjIwOTEgNCA4IDRDNS43OTA5IDQgNCA1Ljc5MDkgNCA4QzQgMTAuMjA5MSA1Ljc5MDkgMTIgOCAxMloiIGZpbGw9IiM2QjcyODAiLz4KPC9zdmc+Cjwvc3ZnPgo=';
                                        }}
                                      />
                                    ) : player.discordId ? (
                                      <div className="h-6 w-6 sm:h-8 sm:w-8 rounded-full bg-slate-200 dark:bg-slate-600 flex items-center justify-center">
                                        <div className="w-2.5 h-2.5 sm:w-3 sm:h-3 border border-slate-400 border-t-transparent rounded-full animate-spin-smooth"></div>
                                      </div>
                                    ) : (
                                      <div className="h-6 w-6 sm:h-8 sm:w-8 rounded-full bg-slate-200 dark:bg-slate-600 flex items-center justify-center">
                                        <svg className="w-3 h-3 sm:w-4 sm:h-4 text-slate-500" fill="currentColor" viewBox="0 0 20 20">
                                          <path fillRule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clipRule="evenodd" />
                                        </svg>
                                      </div>
                                    )}
                                  </div>
                                  <div className="ml-2 sm:ml-4 min-w-0 flex-1">
                                    <div className="text-xs sm:text-sm font-medium text-slate-900 dark:text-white truncate">
                                      {player.name}
                                    </div>
                                  </div>
                                        <div className="w-2.5 h-2.5 sm:w-3 sm:h-3 border border-slate-400 border-t-transparent rounded-full animate-spin-smooth"></div>
                              </td>
                              <td className="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap">
                                <span className="inline-flex items-center px-2 sm:px-2.5 py-0.5 rounded-full text-xs font-medium bg-slate-100 dark:bg-slate-700 text-slate-800 dark:text-white table-text-white">
                                  {player.id}
                                </span>
                              </td>
                              <td className="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap">
                                <span className={`inline-flex items-center px-2 sm:px-2.5 py-0.5 rounded-full text-xs font-medium table-text-white ${player.ping < 50
                                  ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-white'
                                  : player.ping < 100
                                    ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-white'
                                    : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-white'
                                  }`}>
                                  {player.ping}ms
                                </span>
                              </td>
                            </tr>
                          ))
                        ) : (
                          <tr>
                            <td colSpan={3} className="px-3 sm:px-6 py-8 sm:py-12 text-center">
                              <div className="text-slate-500 dark:text-slate-400">
                                <svg className="mx-auto h-8 w-8 sm:h-12 sm:w-12 mb-3 sm:mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                </svg>
                                <p className="text-xs sm:text-sm">
                                  {serverData ? 'No players found' : 'Connect to server to view players'}
                                </p>
                              </div>
                            </td>
                          </tr>
                        )}
                      </tbody>
                    </table>
                  </div>

                  {/* Pagination */}
                  {filteredPlayers.length > playersPerPage && (
                    <div className="px-3 sm:px-6 py-3 sm:py-4 border-t border-slate-200 dark:border-slate-700">
                      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-3 sm:space-y-0">
                        <div className="text-xs sm:text-sm text-slate-700 dark:text-slate-300 text-center sm:text-left">
                          Showing {((currentPage - 1) * playersPerPage) + 1} to {Math.min(currentPage * playersPerPage, filteredPlayers.length)} of {filteredPlayers.length} players
                        </div>
                        <div className="flex items-center justify-center space-x-1 sm:space-x-2">
                          <button
                            onClick={() => changePage(Math.max(currentPage - 1, 1))}
                            disabled={currentPage === 1}
                            className="px-2 sm:px-3 py-1.5 sm:py-1 text-xs sm:text-sm bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 rounded-md hover:bg-slate-200 dark:hover:bg-slate-600 disabled:opacity-50 disabled:cursor-not-allowed"
                          >
                            <span className="hidden sm:inline">Previous</span>
                            <span className="sm:hidden">‹</span>
                          </button>

                          <div className="flex items-center space-x-0.5 sm:space-x-1">
                            {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                              let pageNum;
                              if (totalPages <= 5) {
                                pageNum = i + 1;
                              } else if (currentPage <= 3) {
                                pageNum = i + 1;
                              } else if (currentPage >= totalPages - 2) {
                                pageNum = totalPages - 4 + i;
                              } else {
                                pageNum = currentPage - 2 + i;
                              }

                              return (
                                <button
                                  key={pageNum}
                                  onClick={() => changePage(pageNum)}
                                  className={`px-2 sm:px-3 py-1.5 sm:py-1 text-xs sm:text-sm rounded-md ${currentPage === pageNum
                                    ? 'bg-blue-600 text-white'
                                    : 'bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'
                                    }`}
                                >
                                  {pageNum}
                                </button>
                              );
                            })}
                          </div>

                          <button
                            onClick={() => changePage(Math.min(currentPage + 1, totalPages))}
                            disabled={currentPage === totalPages}
                            className="px-2 sm:px-3 py-1.5 sm:py-1 text-xs sm:text-sm bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300 rounded-md hover:bg-slate-200 dark:hover:bg-slate-600 disabled:opacity-50 disabled:cursor-not-allowed"
                          >
                            <span className="hidden sm:inline">Next</span>
                            <span className="sm:hidden">›</span>
                          </button>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Simple Footer */}
                  <div className="px-3 sm:px-6 py-4 bg-slate-50 dark:bg-slate-900 border-t border-slate-200 dark:border-slate-700">
                    <div className="text-center">
                      <div className="text-xs text-slate-500 dark:text-slate-400 space-y-2">
                        <p>
                          FiveM Player Monitor by <span className="font-medium">บาร็อง อิสหาด</span>
                          <span className="ml-2 px-2 py-0.5 bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-400 rounded-full text-xs">
                            v{import.meta.env.VITE_APP_VERSION || '1.0.5'}
                          </span>
                        </p>
                        {playerDataHash && (
                          <div className="flex flex-col items-center space-y-1">
                            <div className="flex items-center space-x-2">
                              <span className="text-xs">Data Hash </span>
                              <span className="text-xs px-2 py-0.5 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-full">
                                {playerDataHash.length} chars
                              </span>
                              {playerDataHash.length === 64 && (
                                <span className="text-xs px-2 py-0.5 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded-full">
                                  ✓ Valid SHA-256
                                </span>
                              )}
                            </div>
                            <div className="bg-slate-100 dark:bg-slate-800 rounded-lg p-2 border border-slate-200 dark:border-slate-600">
                              <HashDisplay hash={playerDataHash} counter={hashCounter} />
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Notifications */}
        {showLoading && <LoadingIndicator />}
        <NotificationList />

        {/* Edit Server Modal */}
        {showEditModal && <EditServerModal />}

        {/* Share Dialog */}
        <Dialog
          open={showShareDialog}
          onClose={handleShareDialogClose}
          maxWidth="sm"
          fullWidth
          PaperProps={{
            sx: {
              borderRadius: 4,
              bgcolor: currentTheme === 'dark' ? '#1e293b' : '#ffffff',
              color: currentTheme === 'dark' ? '#ffffff' : '#1f2937',
              border: currentTheme === 'dark' ? '1px solid #374151' : '1px solid #e5e7eb',
              boxShadow: currentTheme === 'dark'
                ? '0 25px 50px -12px rgba(0, 0, 0, 0.8)'
                : '0 25px 50px -12px rgba(0, 0, 0, 0.25)',
              overflow: 'hidden'
            }
          }}
          BackdropProps={{
            sx: {
              bgcolor: 'rgba(0, 0, 0, 0.7)',
              backdropFilter: 'blur(8px)'
            }
          }}
        >
          {/* Header with gradient */}
          <Box sx={{
            background: currentTheme === 'dark'
              ? 'linear-gradient(135deg, #1e293b 0%, #334155 100%)'
              : 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)',
            p: 3,
            color: '#ffffff'
          }}>
            <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
              <Box sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>
                <Box sx={{
                  p: 1.5,
                  borderRadius: 2,
                  bgcolor: 'rgba(255, 255, 255, 0.1)',
                  backdropFilter: 'blur(10px)'
                }}>
                  <ShareIcon sx={{ fontSize: 24 }} />
                </Box>
                <Box>
                  <Typography variant="h6" sx={{ fontWeight: 600, mb: 0.5 }}>
                    แชร์ลิงก์เซิร์ฟเวอร์
                  </Typography>
                  <Typography variant="body2" sx={{ opacity: 0.8 }}>
                    สร้างลิงก์สำหรับแชร์ให้เพื่อนๆ
                  </Typography>
                </Box>
              </Box>
              <IconButton
                onClick={handleShareDialogClose}
                sx={{
                  color: 'rgba(255, 255, 255, 0.8)',
                  '&:hover': {
                    bgcolor: 'rgba(255, 255, 255, 0.1)',
                    color: '#ffffff'
                  }
                }}
              >
                <CloseIcon />
              </IconButton>
            </Box>
          </Box>

          <DialogContent sx={{
            p: 3,
            bgcolor: currentTheme === 'dark' ? '#1e293b' : '#ffffff'
          }}>
            {/* Server Info Card */}
            <Paper
              elevation={0}
              sx={{
                p: 3,
                mb: 3,
                bgcolor: currentTheme === 'dark' ? '#374151' : '#f8fafc',
                border: `1px solid ${currentTheme === 'dark' ? '#4b5563' : '#e2e8f0'}`,
                borderRadius: 3,
                position: 'relative',
                overflow: 'hidden'
              }}
            >
              {/* Decorative element */}
              <Box sx={{
                position: 'absolute',
                top: 0,
                left: 0,
                right: 0,
                height: 4,
                background: 'linear-gradient(90deg, #3b82f6, #10b981, #f59e0b)'
              }} />

              <Typography
                variant="subtitle1"
                sx={{
                  mb: 2,
                  fontWeight: 600,
                  color: currentTheme === 'dark' ? '#ffffff' : '#1f2937',
                  display: 'flex',
                  alignItems: 'center',
                  gap: 1
                }}
              >
                <Box sx={{
                  width: 8,
                  height: 8,
                  borderRadius: '50%',
                  bgcolor: '#10b981'
                }} />
                ข้อมูลเซิร์ฟเวอร์
              </Typography>

              <Box sx={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(120px, 1fr))', gap: 1.5 }}>
                <Chip
                  label={`${serverIp}`}
                  size="medium"
                  sx={{
                    bgcolor: currentTheme === 'dark' ? '#1e293b' : '#ffffff',
                    color: currentTheme === 'dark' ? '#60a5fa' : '#3b82f6',
                    border: `1px solid ${currentTheme === 'dark' ? '#3b82f6' : '#3b82f6'}`,
                    fontWeight: 600,
                    '& .MuiChip-label': { px: 2 }
                  }}
                  icon={<Box sx={{ width: 6, height: 6, borderRadius: '50%', bgcolor: '#3b82f6' }} />}
                />
                <Chip
                  label={`Port: ${serverPort}`}
                  size="medium"
                  sx={{
                    bgcolor: currentTheme === 'dark' ? '#1e293b' : '#ffffff',
                    color: currentTheme === 'dark' ? '#34d399' : '#10b981',
                    border: `1px solid ${currentTheme === 'dark' ? '#10b981' : '#10b981'}`,
                    fontWeight: 600,
                    '& .MuiChip-label': { px: 2 }
                  }}
                  icon={<Box sx={{ width: 6, height: 6, borderRadius: '50%', bgcolor: '#10b981' }} />}
                />
                {customShareName && (
                  <Chip
                    label={customShareName}
                    size="medium"
                    sx={{
                      bgcolor: currentTheme === 'dark' ? '#1e293b' : '#ffffff',
                      color: currentTheme === 'dark' ? '#fbbf24' : '#f59e0b',
                      border: `1px solid ${currentTheme === 'dark' ? '#f59e0b' : '#f59e0b'}`,
                      fontWeight: 600,
                      '& .MuiChip-label': { px: 2 }
                    }}
                    icon={<Box sx={{ width: 6, height: 6, borderRadius: '50%', bgcolor: '#f59e0b' }} />}
                  />
                )}
              </Box>
            </Paper>

            {/* Server Name Input */}
            <TextField
              fullWidth
              label="ชื่อเซิร์ฟเวอร์ (ไม่บังคับ)"
              value={localCustomShareName}
              onChange={handleCustomShareNameChange}
              placeholder="เช่น Startown2.0, What City, Bangkok RP"
              variant="outlined"
              sx={{ mb: 2 }}
              InputProps={{
                sx: {
                  borderRadius: 3,
                  bgcolor: currentTheme === 'dark' ? '#374151' : '#ffffff',
                  color: currentTheme === 'dark' ? '#ffffff' : '#1f2937',
                  '& .MuiOutlinedInput-notchedOutline': {
                    borderColor: currentTheme === 'dark' ? '#4b5563' : '#d1d5db',
                    borderWidth: 2
                  },
                  '&:hover .MuiOutlinedInput-notchedOutline': {
                    borderColor: currentTheme === 'dark' ? '#6b7280' : '#9ca3af'
                  },
                  '&.Mui-focused .MuiOutlinedInput-notchedOutline': {
                    borderColor: '#3b82f6',
                    borderWidth: 2
                  }
                }
              }}
              InputLabelProps={{
                sx: {
                  color: currentTheme === 'dark' ? '#9ca3af' : '#6b7280',
                  '&.Mui-focused': {
                    color: '#3b82f6'
                  }
                }
              }}
            />

            {/* Shared By Input with Dropdown */}
            <Box sx={{ position: 'relative', mb: 3 }}>
              <TextField
                fullWidth
                label="แชร์โดย (ไม่บังคับ)"
                value={localSharedFromUser}
                onChange={handleSharedFromUserChange}
                placeholder="เช่น ชื่อของคุณ หรือ ชื่อกิลด์"
                variant="outlined"
                InputProps={{
                  sx: {
                    borderRadius: 3,
                    bgcolor: currentTheme === 'dark' ? '#374151' : '#ffffff',
                    color: currentTheme === 'dark' ? '#ffffff' : '#1f2937',
                    '& .MuiOutlinedInput-notchedOutline': {
                      borderColor: currentTheme === 'dark' ? '#4b5563' : '#d1d5db',
                      borderWidth: 2
                    },
                    '&:hover .MuiOutlinedInput-notchedOutline': {
                      borderColor: currentTheme === 'dark' ? '#6b7280' : '#9ca3af'
                    },
                    '&.Mui-focused .MuiOutlinedInput-notchedOutline': {
                      borderColor: '#10b981',
                      borderWidth: 2
                    }
                  }
                }}
                InputLabelProps={{
                  sx: {
                    color: currentTheme === 'dark' ? '#9ca3af' : '#6b7280',
                    '&.Mui-focused': {
                      color: '#10b981'
                    }
                  }
                }}
                onFocus={() => setShowSharedByDropdown(true)}
                onBlur={() => setTimeout(() => setShowSharedByDropdown(false), 200)}
              />

              {/* Dropdown for Shared By suggestions */}
              {showSharedByDropdown && (
                <Paper
                  elevation={8}
                  sx={{
                    position: 'absolute',
                    top: '100%',
                    left: 0,
                    right: 0,
                    zIndex: 1000,
                    mt: 1,
                    bgcolor: currentTheme === 'dark' ? '#1e293b' : '#ffffff',
                    border: `1px solid ${currentTheme === 'dark' ? '#374151' : '#e5e7eb'}`,
                    borderRadius: 2,
                    maxHeight: 200,
                    overflow: 'auto'
                  }}
                >
                  {discordUser && (
                    <>
                      <Box
                        onClick={() => {
                          const username = discordUser.global_name || discordUser.username;
                          setLocalSharedFromUser(username);
                          setSharedFromUser(username);
                          setShowSharedByDropdown(false);
                        }}
                        sx={{
                          p: 2,
                          cursor: 'pointer',
                          display: 'flex',
                          alignItems: 'center',
                          gap: 2,
                          '&:hover': {
                            bgcolor: currentTheme === 'dark' ? '#374151' : '#f3f4f6'
                          }
                        }}
                      >
                        <img
                          src={discordUser.avatar_url || `https://cdn.discordapp.com/embed/avatars/${parseInt(discordUser.discriminator || '0') % 5}.png`}
                          alt="Discord Avatar"
                          style={{ width: 32, height: 32, borderRadius: '50%' }}
                          onError={(e) => {
                            e.currentTarget.src = `https://cdn.discordapp.com/embed/avatars/${parseInt(discordUser.discriminator || '0') % 5}.png`;
                          }}
                        />
                        <Box sx={{ flex: 1 }}>
                          <Typography variant="body2" sx={{ fontWeight: 500, color: currentTheme === 'dark' ? '#ffffff' : '#1f2937' }}>
                            {discordUser.global_name || discordUser.username}
                          </Typography>
                          <Typography variant="caption" sx={{ color: currentTheme === 'dark' ? '#9ca3af' : '#6b7280' }}>
                            Discord Profile
                          </Typography>
                        </Box>
                      </Box>

                    </>
                  )}

                  <Box
                    onClick={() => {
                      setLocalSharedFromUser('');
                      setSharedFromUser('');
                      setShowSharedByDropdown(false);
                    }}
                    sx={{
                      p: 2,
                      cursor: 'pointer',
                      display: 'flex',
                      alignItems: 'center',
                      gap: 2,
                      borderTop: discordUser ? `1px solid ${currentTheme === 'dark' ? '#374151' : '#e5e7eb'}` : 'none',
                      '&:hover': {
                        bgcolor: currentTheme === 'dark' ? '#374151' : '#f3f4f6'
                      }
                    }}
                  >
                    <Box
                      sx={{
                        width: 32,
                        height: 32,
                        borderRadius: '50%',
                        bgcolor: currentTheme === 'dark' ? '#374151' : '#e5e7eb',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center'
                      }}
                    >
                      <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                      </svg>
                    </Box>
                    <Box>
                      <Typography variant="body2" sx={{ fontWeight: 500, color: currentTheme === 'dark' ? '#ffffff' : '#1f2937' }}>
                        ไม่ระบุชื่อ
                      </Typography>
                      <Typography variant="caption" sx={{ color: currentTheme === 'dark' ? '#9ca3af' : '#6b7280' }}>
                        แชร์โดยไม่แสดงชื่อ
                      </Typography>
                    </Box>
                  </Box>

                  <Box
                    onClick={() => {
                      setLocalSharedFromUser('ชุมชนเกมเมอร์');
                      setSharedFromUser('ชุมชนเกมเมอร์');
                      setShowSharedByDropdown(false);
                    }}
                    sx={{
                      p: 2,
                      cursor: 'pointer',
                      display: 'flex',
                      alignItems: 'center',
                      gap: 2,
                      borderTop: `1px solid ${currentTheme === 'dark' ? '#374151' : '#e5e7eb'}`,
                      '&:hover': {
                        bgcolor: currentTheme === 'dark' ? '#374151' : '#f3f4f6'
                      }
                    }}
                  >
                    <Box
                      sx={{
                        width: 32,
                        height: 32,
                        borderRadius: '50%',
                        bgcolor: '#10b981',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center'
                      }}
                    >
                      <svg width="16" height="16" fill="white" viewBox="0 0 24 24">
                        <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A1.5 1.5 0 0 0 18.5 7h-5c-.83 0-1.5.67-1.5 1.5v6c0 .83.67 1.5 1.5 1.5H16v6h4zM12.5 11.5c.83 0 1.5-.67 1.5-1.5V4c0-1.11-.89-2-2-2s-2 .89-2 2v6c0 .83.67 1.5 1.5 1.5zm-2 .5H8c-.83 0-1.5.67-1.5 1.5v8c0 .83.67 1.5 1.5 1.5h2.5v-11zm-6-1c1.11 0 2-.89 2-2s-.89-2-2-2-2 .89-2 2 .89 2 2 2zm2.5 1H6c-.83 0-1.5.67-1.5 1.5v8c0 .83.67 1.5 1.5 1.5h2.5v-11z" />
                      </svg>
                    </Box>
                    <Box>
                      <Typography variant="body2" sx={{ fontWeight: 500, color: currentTheme === 'dark' ? '#ffffff' : '#1f2937' }}>
                        ชุมชนเกมเมอร์
                      </Typography>
                      <Typography variant="caption" sx={{ color: currentTheme === 'dark' ? '#9ca3af' : '#6b7280' }}>
                        ตัวอย่างชื่อกลุ่ม
                      </Typography>
                    </Box>
                  </Box>
                </Paper>
              )}
            </Box>

            {/* Generate URL Button */}
            <Box sx={{ mb: 3, display: 'flex', justifyContent: 'center' }}>
              <Button
                onClick={generateShareUrlManual}
                disabled={isGeneratingUrl || (!serverIp.trim() && !window.location.search)}
                variant="contained"
                sx={{
                  borderRadius: 3,
                  px: 4,
                  py: 1.5,
                  bgcolor: '#10b981',
                  color: 'white',
                  fontWeight: 600,
                  '&:hover': {
                    bgcolor: '#059669'
                  },
                  '&:disabled': {
                    bgcolor: currentTheme === 'dark' ? '#374151' : '#e5e7eb',
                    color: currentTheme === 'dark' ? '#6b7280' : '#9ca3af'
                  }
                }}
                startIcon={isGeneratingUrl ? (
                  <Box sx={{
                    width: 16,
                    height: 16,
                    bgcolor: 'white',
                    borderRadius: '50%',
                    animation: 'pulse 1.5s ease-in-out infinite'
                  }} />
                ) : (
                  <LinkIcon sx={{ fontSize: 18 }} />
                )}
              >
                {isGeneratingUrl ? 'กำลังสร้างลิงก์...' : 'สร้างลิงก์'}
              </Button>
            </Box>

            {/* Generated URL - Show only when URL exists */}
            {shareUrl && (
              <Paper
                elevation={0}
                sx={{
                  p: 3,
                  bgcolor: currentTheme === 'dark' ? '#374151' : '#f8fafc',
                  border: `2px solid ${shareUrl ? (currentTheme === 'dark' ? '#10b981' : '#10b981') : (currentTheme === 'dark' ? '#4b5563' : '#d1d5db')}`,
                  borderRadius: 3,
                  position: 'relative',
                  transition: 'border-color 0.3s ease'
                }}
              >
                <Typography
                  variant="subtitle2"
                  sx={{
                    mb: 2,
                    color: shareUrl ? (currentTheme === 'dark' ? '#34d399' : '#059669') : (currentTheme === 'dark' ? '#9ca3af' : '#6b7280'),
                    fontWeight: 600,
                    display: 'flex',
                    alignItems: 'center',
                    gap: 1,
                    transition: 'color 0.3s ease'
                  }}
                >
                  <LinkIcon sx={{ fontSize: 18 }} />
                  ลิงก์สำหรับแชร์
                </Typography>

                <Box sx={{
                  p: 2,
                  bgcolor: currentTheme === 'dark' ? '#1e293b' : '#ffffff',
                  borderRadius: 2,
                  border: `1px solid ${currentTheme === 'dark' ? '#4b5563' : '#e5e7eb'}`,
                  fontFamily: 'monospace',
                  fontSize: '0.875rem',
                  color: shareUrl ? (currentTheme === 'dark' ? '#d1d5db' : '#374151') : (currentTheme === 'dark' ? '#6b7280' : '#9ca3af'),
                  wordBreak: 'break-all',
                  position: 'relative',
                  minHeight: '60px',
                  display: 'flex',
                  alignItems: 'center',
                  transition: 'all 0.3s ease'
                }}>
                  {isGeneratingUrl ? (
                    <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                      <Box sx={{
                        width: 16,
                        height: 16,
                        bgcolor: '#3b82f6',
                        borderRadius: '50%',
                        animation: 'pulse 1.5s ease-in-out infinite'
                      }} />
                      กำลังสร้างลิงก์...
                    </Box>
                  ) : (
                    shareUrl
                  )}

                  {shareUrl && !isGeneratingUrl && (
                    <IconButton
                      onClick={copyShareUrl}
                      sx={{
                        position: 'absolute',
                        top: 4,
                        right: 4,
                        color: currentTheme === 'dark' ? '#9ca3af' : '#6b7280',
                        bgcolor: currentTheme === 'dark' ? '#374151' : '#f3f4f6',
                        '&:hover': {
                          bgcolor: currentTheme === 'dark' ? '#4b5563' : '#e5e7eb',
                          color: currentTheme === 'dark' ? '#ffffff' : '#1f2937'
                        }
                      }}
                      size="small"
                    >
                      <CopyIcon sx={{ fontSize: 16 }} />
                    </IconButton>
                  )}
                </Box>
              </Paper>
            )}

          </DialogContent>

          <DialogActions sx={{
            p: 3,
            bgcolor: currentTheme === 'dark' ? '#1e293b' : '#ffffff',
            borderTop: `1px solid ${currentTheme === 'dark' ? '#374151' : '#e5e7eb'}`,
            gap: 2
          }}>
            <Button
              onClick={handleShareDialogClose}
              variant="outlined"
              sx={{
                borderRadius: 3,
                px: 3,
                py: 1,
                color: currentTheme === 'dark' ? '#9ca3af' : '#6b7280',
                borderColor: currentTheme === 'dark' ? '#4b5563' : '#d1d5db',
                '&:hover': {
                  bgcolor: currentTheme === 'dark' ? '#374151' : '#f3f4f6',
                  borderColor: currentTheme === 'dark' ? '#6b7280' : '#9ca3af'
                }
              }}
            >
              ปิด
            </Button>

            <Button
              onClick={copyShareUrl}
              variant="contained"
              startIcon={isGeneratingUrl ? (
                <Box sx={{
                  width: 16,
                  height: 16,
                  bgcolor: '#ffffff',
                  borderRadius: '50%',
                  animation: 'pulse 1.5s ease-in-out infinite'
                }} />
              ) : <CopyIcon />}
              disabled={!shareUrl || isGeneratingUrl}
              sx={{
                borderRadius: 3,
                px: 4,
                py: 1,
                bgcolor: shareUrl && !isGeneratingUrl ? '#10b981' : (currentTheme === 'dark' ? '#374151' : '#e5e7eb'),
                '&:hover': {
                  bgcolor: shareUrl && !isGeneratingUrl ? '#059669' : (currentTheme === 'dark' ? '#4b5563' : '#d1d5db')
                },
                color: shareUrl && !isGeneratingUrl ? '#ffffff' : (currentTheme === 'dark' ? '#6b7280' : '#9ca3af'),
                fontWeight: 600,
                boxShadow: shareUrl && !isGeneratingUrl ? '0 4px 12px rgba(16, 185, 129, 0.3)' : 'none',
                transition: 'all 0.3s ease',
                '&.Mui-disabled': {
                  color: currentTheme === 'dark' ? '#6b7280' : '#9ca3af'
                }
              }}
            >
              {isGeneratingUrl ? 'กำลังสร้าง...' : shareUrl ? 'คัดลอกลิงก์' : 'รอข้อมูล...'}
            </Button>
          </DialogActions>
        </Dialog>



      </div>
    </ThemeProvider>
  );
};

export default App;